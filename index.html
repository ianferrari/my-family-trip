<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Travel OS Pro</title>
    <style>
        :root {
            --ios-bg: #F2F2F7;
            --ios-card: #FFFFFF;
            --primary-color: #007AFF;
            --text-gray: #8E8E93;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.06);
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif; background-color: var(--ios-bg); margin: 0; padding: 0; color: #1C1C1E; -webkit-tap-highlight-color: transparent; }
        
        /* æ¨™é¡Œå€ */
        header { background: rgba(255,255,255,0.9); backdrop-filter: saturate(180%) blur(20px); position: sticky; top: 0; z-index: 100; border-bottom: 0.5px solid rgba(0,0,0,0.1); padding: 12px 20px; }
        header h1 { margin: 0; font-size: 24px; font-weight: 800; }
        header p { margin: 2px 0 0; font-size: 12px; color: var(--text-gray); }
        
        /* ç¬¬ä¸€å±¤ï¼šå¤§åˆ†é¡ Tab */
        .main-tabs { display: flex; padding: 10px 15px; background: #fff; justify-content: space-between; gap: 8px; }
        .tab-btn { 
            flex: 1; border: none; background: #F2F2F7; color: #8E8E93; 
            padding: 10px 0; border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;
            display: flex; flex-direction: column; align-items: center; gap: 4px;
        }
        .tab-btn.active { background: #E5F1FF; color: #007AFF; }
        .tab-icon { font-size: 18px; }

        /* ç¬¬äºŒå±¤ï¼šç´°é …è† å›Š (å·¦å³æ»‘å‹•) */
        .sub-nav-container { background: #fff; padding: 5px 15px 15px 15px; border-bottom: 1px solid #eee; overflow: hidden; }
        .sub-scroll-wrapper { 
            display: flex; gap: 10px; overflow-x: auto; 
            padding-bottom: 5px; scrollbar-width: none;
        }
        .sub-scroll-wrapper::-webkit-scrollbar { display: none; }

        .chip-btn { 
            border: 1px solid #E5E5EA; background: #fff; color: #1C1C1E;
            padding: 8px 16px; font-size: 13px; font-weight: 500; border-radius: 20px; 
            white-space: nowrap; cursor: pointer; transition: all 0.2s; flex-shrink: 0;
        }
        .chip-btn.active { background: #007AFF; color: #fff; border-color: #007AFF; box-shadow: 0 4px 10px rgba(0,122,255,0.3); }

        /* ç‹€æ…‹åˆ— */
        #status { text-align: center; margin: 10px 0; font-size: 12px; color: var(--text-gray); min-height: 20px; }
        
        /* åœ°åœ–èˆ‡åˆ—è¡¨ */
        .map-wrapper { padding: 0 20px; margin-bottom: 20px; }
        #map { width: 100%; height: 35vh; border-radius: 24px; box-shadow: var(--shadow-sm); background-color: #E5E5EA; }
        
        .results-container { padding: 0 20px 80px 20px; max-width: 600px; margin: 0 auto; }
        .place-card { background: #fff; border-radius: 20px; padding: 20px; margin-bottom: 16px; box-shadow: var(--shadow-sm); border: 1px solid rgba(0,0,0,0.02); animation: fadeInUp 0.5s ease forwards; }
        .place-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .place-name { font-size: 17px; font-weight: 700; color: #000; line-height: 1.3; }
        .place-rating { background: #FFF3E0; color: #FF9500; padding: 4px 8px; border-radius: 8px; font-size: 12px; font-weight: 700; flex-shrink: 0; margin-left: 8px; }
        
        .ai-tip { background-color: #F2F2F7; padding: 10px 14px; border-radius: 12px; font-size: 13px; line-height: 1.4; margin-top: 10px; color: #333; }
        .ai-tip strong { color: #007AFF; }

        .open-now { color: #34C759; font-size: 12px; font-weight: 600; }
        .closed-now { color: #FF3B30; font-size: 12px; font-weight: 600; }
        
        .empty-state { text-align: center; margin-top: 40px; color: #C7C7CC; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<header>
    <h1>Travel OS Pro</h1>
    <p>å…¨å®¶äººçš„æ™ºæ…§å°éŠ</p>
</header>

<div class="main-tabs">
    <button class="tab-btn active" onclick="selectCategory('fun')">
        <span class="tab-icon">ğŸ¡</span>ç©æ¨‚
    </button>
    <button class="tab-btn" onclick="selectCategory('food')">
        <span class="tab-icon">ğŸ´</span>ç¾é£Ÿ
    </button>
    <button class="tab-btn" onclick="selectCategory('medical')">
        <span class="tab-icon">ğŸš‘</span>å¥åº·
    </button>
    <button class="tab-btn" onclick="selectCategory('life')">
        <span class="tab-icon">ğŸ…¿ï¸</span>ä¾¿åˆ©
    </button>
</div>

<div class="sub-nav-container">
    <div class="sub-scroll-wrapper" id="sub-nav">
        </div>
</div>

<div id="status">æº–å‚™å°±ç·’</div>

<div class="map-wrapper">
    <div id="map"></div>
</div>

<div class="results-container" id="results">
    <div class="empty-state">
        <p>è«‹é¸æ“‡ä¸Šæ–¹é¡åˆ¥é–‹å§‹æ¢ç´¢</p>
    </div>
</div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDyaGpwDguvqVwYGPN1CsVbuddU18dtHEs&loading=async&libraries=places,maps"></script>

<script>
    let map;
    let userLocation = null;
    let currentMarkers = [];

    // ğŸŒŸ è¨­å®šæª”ï¼šæ‰€æœ‰æŒ‰éˆ•çš„é‚è¼¯éƒ½åœ¨é€™è£¡ï¼Œæƒ³æ”¹å°±åœ¨é€™æ”¹
    const CATEGORIES = {
        'fun': [
            { name: "å…¬åœ’/å­¸æ ¡", query: "å…¬åœ’ åœ‹å°éŠæ¨‚å ´", icon: "ğŸ›" },
            { name: "ç™¾è²¨å…¬å¸", query: "ç™¾è²¨å…¬å¸ è³¼ç‰©ä¸­å¿ƒ", icon: "ğŸ›ï¸" },
            { name: "å®¤å…§éŠæ¨‚", query: "å®¤å…§éŠæ¨‚åœ’ è¦ªå­é¤¨ éŠæˆ²å ´", icon: "ğŸ§©" },
            { name: "å‹•ç‰©/æ°´æ—", query: "å‹•ç‰©åœ’ æ°´æ—é¤¨", icon: "ğŸ¦„" },
            { name: "è§€å…‰æ™¯é»", query: "è§€å…‰æ™¯é»", icon: "ğŸ“¸" }
        ],
        'food': [
            { name: "è¦ªå­å¯µç‰©", query: "è¦ªå­é¤å»³ å¯µç‰©å‹å–„ å®¶åº­é¤å»³", icon: "ğŸ‘¶" },
            { name: "ç‡’è‚‰ç«é‹", query: "ç‡’è‚‰ ç«é‹ éº»è¾£é‹ å£½å–œç‡’", icon: "ğŸ”¥" },
            { name: "åœ¨åœ°å°åƒ", query: "å¿…åƒç¾é£Ÿ åœ¨åœ°å°åƒ è€åº— éºµåº—", icon: "ğŸœ" },
            { name: "èŒ¶é¤¨å’–å•¡", query: "å’–å•¡å»³ èŒ¶é¤¨ ç”œé» ä¸‹åˆèŒ¶", icon: "â˜•" },
            { name: "é…’å§å±…é…’å±‹", query: "å±…é…’å±‹ é…’å§ é¤é…’é¤¨", icon: "ğŸº" }
        ],
        'medical': [
            { name: "å°å…’ç§‘", query: "å°å…’ç§‘è¨ºæ‰€", icon: "ğŸŒ¡ï¸" },
            { name: "è€³é¼»å–‰ç§‘", query: "è€³é¼»å–‰ç§‘è¨ºæ‰€", icon: "ğŸ‘‚" },
            { name: "æ€¥è¨ºé†«é™¢", query: "æ€¥è¨º ç¶œåˆé†«é™¢", icon: "ğŸ¥" },
            { name: "è—¥å±€", query: "è—¥å±€", icon: "ğŸ’Š" }
        ],
        'life': [
            { name: "åœè»Šå ´", query: "åœè»Šå ´", icon: "ğŸ…¿ï¸" },
            { name: "è¶…å•†è¶…å¸‚", query: "ä¾¿åˆ©å•†åº— è¶…å¸‚", icon: "ğŸª" },
            { name: "åŠ æ²¹ç«™", query: "åŠ æ²¹ç«™", icon: "â›½" },
            { name: "å»æ‰€", query: "å…¬å»", icon: "ğŸš¾" }
        ]
    };

    // é è¨­å•Ÿå‹•
    let currentCategory = 'fun';
    window.onload = () => { renderSubNav('fun'); };

    // åˆ‡æ›å¤§åˆ†é¡
    function selectCategory(cat) {
        currentCategory = cat;
        
        // æ›´æ–° Tab æ¨£å¼
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.currentTarget.classList.add('active');
        
        // é‡æ–°ç”¢ç”Ÿä¸‹é¢çš„å°æŒ‰éˆ•
        renderSubNav(cat);
    }

    // ç”¢ç”Ÿç¬¬äºŒå±¤æŒ‰éˆ•
    function renderSubNav(cat) {
        const container = document.getElementById('sub-nav');
        container.innerHTML = ''; // æ¸…ç©º
        
        const options = CATEGORIES[cat];
        options.forEach((opt, index) => {
            const btn = document.createElement('button');
            btn.className = 'chip-btn';
            btn.innerHTML = `${opt.icon} ${opt.name}`;
            btn.onclick = () => startSearch(opt.query, btn);
            container.appendChild(btn);
        });
    }

    // é–‹å§‹æœå°‹
    function startSearch(query, btnElement) {
        // æ›´æ–°æŒ‰éˆ•æ¨£å¼
        document.querySelectorAll('.chip-btn').forEach(b => b.classList.remove('active'));
        btnElement.classList.add('active');
        
        const statusDiv = document.getElementById('status');
        statusDiv.innerHTML = "å®šä½ä¸­...";

        // 1. æ¸…ç©ºçµæœ
        document.getElementById('results').innerHTML = '<div class="empty-state"><p>Loading...</p></div>';
        clearMarkers();

        // 2. æŠ“ä½ç½®ä¸¦æœå°‹
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    userLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
                    statusDiv.innerHTML = `æ­£åœ¨æœå°‹ï¼š${query}...`;
                    
                    await initMap(userLocation.lat, userLocation.lng);
                    await performSearch(userLocation, query);
                    
                    statusDiv.innerHTML = "æœå°‹å®Œæˆ";
                },
                (error) => { statusDiv.innerHTML = "âŒ å®šä½å¤±æ•—"; }
            );
        } else { statusDiv.innerHTML = "âŒ ä¸æ”¯æ´å®šä½"; }
    }

    // Google Maps é‚è¼¯
    async function initMap(lat, lng) {
        const { Map } = await google.maps.importLibrary("maps");
        const center = { lat: lat, lng: lng };
        if (!map) {
            map = new Map(document.getElementById("map"), {
                center: center, zoom: 15, mapId: "DEMO_MAP_ID", disableDefaultUI: true, gestureHandling: "greedy"
            });
        } else {
            map.setCenter(center); map.setZoom(15);
        }
        // ç•«ä¸€å€‹è—è‰²é»é»ä»£è¡¨è‡ªå·±
        new google.maps.Marker({
            position: center, map: map,
            icon: { path: google.maps.SymbolPath.CIRCLE, scale: 8, fillColor: "#007AFF", fillOpacity: 1, strokeWeight: 2, strokeColor: "white" },
            zIndex: 999 
        });
    }

    function clearMarkers() {
        currentMarkers.forEach(marker => marker.setMap(null));
        currentMarkers = [];
    }

    // çµ±ä¸€æœå°‹å‡½æ•¸ (ä½¿ç”¨ Text Search æœ€éˆæ´»)
    async function performSearch(location, query) {
        const { Place } = await google.maps.importLibrary("places");
        try {
            const request = {
                textQuery: query, 
                fields: ['displayName', 'location', 'businessStatus', 'rating', 'types', 'formattedAddress', 'userRatingCount'],
                locationBias: { center: location, radius: 1000 },
                maxResultCount: 20, // å¢åŠ çµæœæ•¸é‡
                language: 'zh-TW',
            };
            
            const { places } = await Place.searchByText(request);
            
            if (places && places.length > 0) {
                displayResults(places, query);
            } else {
                document.getElementById('results').innerHTML = '<div class="empty-state"><p>é™„è¿‘æ‰¾ä¸åˆ°ç›¸é—œåœ°é»</p></div>';
            }
        } catch (e) {
            console.error(e);
            document.getElementById('results').innerHTML = '<div class="empty-state"><p>æœå°‹ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦</p></div>';
        }
    }

    // é¡¯ç¤ºçµæœèˆ‡ AI å»ºè­°
    function displayResults(places, query) {
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = "";
        
        // éæ¿¾ï¼šåªé¡¯ç¤ºç‡Ÿæ¥­ä¸­æˆ–ç„¡ç‹€æ…‹çš„
        const activePlaces = places.filter(p => p.businessStatus === 'OPERATIONAL' || !p.businessStatus);

        if (activePlaces.length === 0) {
            resultsDiv.innerHTML = '<div class="empty-state"><p>é™„è¿‘æ²’æœ‰ç‡Ÿæ¥­ä¸­çš„åœ°é»</p></div>';
            return;
        }

        activePlaces.forEach((place, index) => {
            const name = place.displayName;
            const rating = place.rating || "ç„¡è©•åˆ†";
            const address = place.formattedAddress ? place.formattedAddress.replace('å°ç£å°ä¸­å¸‚', '').replace(/^[0-9]+/, '') : "";
            const isOpen = place.businessStatus === 'OPERATIONAL';
            
            // ç”¢ç”Ÿ AI å»ºè­°
            const advice = generateAdvice(query, place.types, rating);
            
            const card = document.createElement('div');
            card.className = 'place-card';
            card.style.animationDelay = `${index * 0.05}s`;
            card.innerHTML = `
                <div class="place-header">
                    <div class="place-name">${name}</div>
                    <div class="place-rating">â˜… ${rating}</div>
                </div>
                <div style="font-size:13px; color:#8E8E93; margin-bottom:8px;">
                    ${isOpen ? '<span class="open-now">ç‡Ÿæ¥­ä¸­</span>' : '<span class="closed-now">ä¼‘æ¯ä¸­</span>'} â€¢ ${address}
                </div>
                <div class="ai-tip">
                    ${advice}
                </div>
            `;
            
            card.onclick = () => {
                window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(name)}&query_place_id=${place.id}`, '_blank');
            };
            resultsDiv.appendChild(card);
            
            const marker = new google.maps.Marker({
                position: place.location, map: map, title: name
            });
            currentMarkers.push(marker);
        });
    }

    // ç°¡å–®çš„ AI å»ºè­°ç”Ÿæˆå™¨
    function generateAdvice(query, types, rating) {
        let text = "";
        const q = query; 

        if (q.includes("å°å…’ç§‘") || q.includes("è¨ºæ‰€") || q.includes("æ€¥è¨º")) {
            text = "<strong>ğŸš‘ å°±é†«æé†’ï¼š</strong>è«‹è¨˜å¾—æ”œå¸¶å¥ä¿å¡/è­·ç…§ã€‚å‡ºç™¼å‰å»ºè­°å…ˆé›»è©±ç¢ºèªçœ‹è¨ºæ™‚é–“ã€‚";
        } else if (q.includes("åœè»Šå ´")) {
            text = "<strong>ğŸ…¿ï¸ åœè»Šè³‡è¨Šï¼š</strong>å»ºè­°é»æ“Šåœ°åœ–æŸ¥çœ‹æ˜¯å¦ç‚ºç‰¹ç´„åœè»Šå ´æˆ–è²»ç‡ã€‚";
        } else if (q.includes("å…¬åœ’")) {
            text = "<strong>ğŸ› æ”¾é›»ç­†è¨˜ï¼š</strong>æˆ¶å¤–æ´»å‹•è«‹æ³¨æ„é˜²èšŠèˆ‡é˜²æ›¬ï¼Œè¨˜å¾—å¸¶æ°´å£ºã€‚";
        } else if (q.includes("ç‡’è‚‰") || q.includes("ç«é‹")) {
            text = "<strong>ğŸ”¥ ç”¨é¤æ³¨æ„ï¼š</strong>ç‚­ç«/ç†±æ¹¯è«‹ç•™æ„å…’ç«¥å®‰å…¨ã€‚";
            if (rating > 4.5) text += " ç†±é–€æ™‚æ®µå»ºè­°å…ˆè¨‚ä½ã€‚";
        } else if (q.includes("è¦ªå­") || q.includes("éŠæ¨‚")) {
             text = "<strong>ğŸ‘¶ è¦ªå­å‹å–„ï¼š</strong>é©åˆå¸¶å°å­©å‰å¾€ï¼Œå»ºè­°ç¢ºèªæ˜¯å¦éœ€ç©¿è‘—è¥ªå­ã€‚";
        } else if (q.includes("å±…é…’å±‹") || q.includes("é…’å§")) {
            text = "<strong>ğŸº æ”¾é¬†æ™‚åˆ»ï¼š</strong>éƒ¨åˆ†åº—å®¶å¯å¸è¸ï¼Œå»ºè­°å…ˆç¢ºèªç’°å¢ƒæ˜¯å¦é©åˆå…’ç«¥ã€‚";
        } else {
            text = `<strong>ğŸ’¡ æ—…éŠå°å¹«æ‰‹ï¼š</strong>é€™æ˜¯æœå°‹ã€Œ${q.split(' ')[0]}ã€çš„çµæœï¼Œè«‹åƒè€ƒ Google è©•è«–ã€‚`;
        }
        return text;
    }
</script>
</body>
</html>
