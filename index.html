<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Travel OS V2.2</title>
    <style>
        :root {
            --bg-color: #0B1120;        
            --card-bg: #1E293B;         
            --text-main: #F8FAFC;       
            --text-sub: #94A3B8;        
            --accent-green: #10B981;    
            --accent-red: #EF4444;
            --accent-blue: #3B82F6;     
            --review-bg: #0F172A;       
            --nav-btn-bg: #334155;      
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--bg-color); 
            margin: 0; padding: 0; 
            color: var(--text-main); 
            -webkit-tap-highlight-color: transparent; 
        }
        
        header { 
            background: rgba(11, 17, 32, 0.95); 
            backdrop-filter: blur(10px); 
            position: sticky; top: 0; z-index: 100; 
            padding: 16px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex; justify-content: space-between; align-items: center;
        }
        .brand { font-size: 20px; font-weight: 800; letter-spacing: 0.5px; }
        .brand span { font-size: 10px; display: block; color: var(--text-sub); font-weight: 400; margin-top: 2px; }
        .status-dot { width: 8px; height: 8px; background-color: var(--accent-green); border-radius: 50%; box-shadow: 0 0 10px var(--accent-green); }

        .main-tabs { display: flex; padding: 15px 15px 5px; gap: 10px; overflow-x: auto; scrollbar-width: none; }
        .tab-btn { 
            flex: 1; border: 1px solid rgba(255,255,255,0.1); 
            background: rgba(255,255,255,0.05); color: var(--text-sub); 
            padding: 12px 0; border-radius: 24px; font-size: 14px; font-weight: 600; 
            cursor: pointer; transition: all 0.3s; white-space: nowrap; padding-left: 15px; padding-right: 15px;
        }
        .tab-btn.active { background: var(--text-main); color: var(--bg-color); }

        .sub-nav-container { padding: 10px 15px; }
        .sub-scroll-wrapper { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; margin-bottom: 10px; }
        .sub-scroll-wrapper::-webkit-scrollbar { display: none; }

        .chip-btn { 
            border: 1px solid #334155; background: transparent; color: var(--text-sub);
            padding: 8px 16px; font-size: 13px; font-weight: 500; border-radius: 20px; 
            white-space: nowrap; cursor: pointer; transition: all 0.2s; flex-shrink: 0;
            display: flex; align-items: center; gap: 6px;
        }
        .chip-btn.active { background: var(--accent-blue); color: white; border-color: var(--accent-blue); box-shadow: 0 0 15px rgba(59, 130, 246, 0.4); }

        .filter-bar { display: flex; justify-content: space-between; align-items: center; padding: 0 5px; margin-bottom: 10px; gap: 10px; }
        
        .toggle-btn {
            background: #1E293B; border: 1px solid #334155; color: var(--text-sub);
            padding: 6px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;
            display: flex; align-items: center; gap: 6px; cursor: pointer; transition: all 0.2s;
            white-space: nowrap;
        }
        .toggle-btn.active {
            background: rgba(16, 185, 129, 0.2); border-color: var(--accent-green); color: var(--accent-green);
        }
        .toggle-icon { width: 10px; height: 10px; border-radius: 50%; border: 1px solid currentColor; }
        .toggle-btn.active .toggle-icon { background: currentColor; }

        .radius-select {
            background: #1E293B; border: 1px solid #334155; color: var(--text-main);
            padding: 6px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;
            outline: none; -webkit-appearance: none; appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%2394A3B8%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 8px auto;
            padding-right: 25px;
        }

        .map-container { padding: 0 15px; margin-bottom: 20px; opacity: 0; height: 0; transition: all 0.5s; overflow: hidden; }
        .map-container.show { opacity: 1; height: 35vh; }
        #map { width: 100%; height: 100%; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); }

        .results-container { padding: 0 15px 80px 15px; max-width: 600px; margin: 0 auto; }
        
        .place-card { 
            background: var(--card-bg); 
            border-radius: 24px; padding: 20px; margin-bottom: 16px; 
            border: 1px solid rgba(255,255,255,0.05);
            animation: slideUp 0.4s ease forwards;
            transition: border-color 0.3s;
        }

        .card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .place-name { font-size: 18px; font-weight: 700; color: #fff; line-height: 1.3; flex: 1; margin-right: 10px; }
        
        .rating-badge { 
            background: rgba(16, 185, 129, 0.2); color: var(--accent-green); 
            padding: 4px 10px; border-radius: 8px; font-size: 13px; font-weight: 800; 
            display: flex; align-items: center; gap: 4px; flex-shrink: 0;
        }
        .rating-badge.low { background: rgba(239, 68, 68, 0.2); color: var(--accent-red); }

        .status-row { font-size: 13px; color: var(--text-sub); margin-bottom: 8px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .dist-badge { color: var(--accent-blue); background: rgba(59, 130, 246, 0.15); padding: 2px 6px; border-radius: 4px; font-weight: 600; margin-right: 6px; }

        .hours-text { font-size: 12px; color: #64748B; margin-bottom: 15px; display: block; }
        
        .dot-open { width: 6px; height: 6px; background: var(--accent-green); border-radius: 50%; }
        .dot-close { width: 6px; height: 6px; background: #64748B; border-radius: 50%; }

        .review-box {
            background: var(--review-bg); border-radius: 16px; padding: 12px 16px;
            position: relative; margin-bottom: 16px; border-left: 3px solid var(--accent-green);
        }
        .review-box.low { border-left-color: var(--accent-red); } 
        
        .review-label { font-size: 11px; color: var(--accent-green); font-weight: 700; margin-bottom: 4px; }
        .review-box.low .review-label { color: var(--accent-red); }
        
        .review-text { font-size: 13px; color: #CBD5E1; line-height: 1.5; font-style: italic; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }

        .nav-btn {
            width: 100%; background: var(--nav-btn-bg); color: white; border: none;
            padding: 12px; border-radius: 14px; font-size: 14px; font-weight: 700;
            cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 6px;
            transition: background 0.2s;
        }
        .nav-btn:active { background: #475569; transform: scale(0.98); }

        .empty-state { text-align: center; margin-top: 60px; color: var(--text-sub); font-size: 14px; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="app-content">
    <header>
        <div class="brand">
            Travel OS
            <span>GLOBAL EDITION V2.2</span>
        </div>
        <div class="status-dot"></div>
    </header>

    <div class="main-tabs">
        <button class="tab-btn active" onclick="selectCategory('fun')">Áé©Ê®Ç</button>
        <button class="tab-btn" onclick="selectCategory('food')">ÁæéÈ£ü</button>
        <button class="tab-btn" onclick="selectCategory('medical')">ÂÅ•Â∫∑</button>
        <button class="tab-btn" onclick="selectCategory('life')">‰æøÂà©</button>
    </div>

    <div class="sub-nav-container">
        <div class="sub-scroll-wrapper" id="sub-nav"></div>
        
        <div class="filter-bar">
            <select id="radiusSelect" class="radius-select" onchange="refreshSearch()">
                <option value="1000">1 km (Walk)</option>
                <option value="3000" selected>3 km (Bike)</option>
                <option value="5000">5 km (Drive)</option>
                <option value="10000">10 km (Far)</option>
            </select>

            <button class="toggle-btn" id="openFilterBtn" onclick="toggleOpenFilter()">
                <span class="toggle-icon"></span> Open Now
            </button>
        </div>
    </div>

    <div class="map-container" id="map-wrapper">
        <div id="map"></div>
    </div>

    <div class="results-container" id="results">
        <div class="empty-state">
            <p>SYSTEM READY<br>Searching for your location...</p>
        </div>
    </div>
</div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDyaGpwDguvqVwYGPN1CsVbuddU18dtHEs&loading=async&libraries=places,maps,geometry"></script>

<script>
    let map;
    let userLocation = null;
    let currentMarkers = [];
    let allFetchedPlaces = []; 
    let isOnlyOpen = false;    
    let userMarker = null;
    let currentQuery = ""; 
    let currentRadius = 3000; 

    // üåü ‰øÆÊ≠£ÂæåÁöÑ CATEGORIES
    const CATEGORIES = {
        'fun': [
            { name: "ÂÖ¨ÂúíÁ∂†Âú∞", query: "ÂÖ¨Âúí Park", icon: "üõù" },
            { name: "ËßÄÂÖâÊôØÈªû", query: "ËßÄÂÖâÊôØÈªû Tourist Attraction Sightseeing", icon: "üì∏" },
            { name: "ÁôæË≤®Ë≥ºÁâ©", query: "ÁôæË≤®ÂÖ¨Âè∏ Shopping Mall Department Store", icon: "üõçÔ∏è" },
            { name: "ÂÆ§ÂÖßÈÅäÊ®Ç", query: "ÂÆ§ÂÖßÈÅäÊ®ÇÂúí Indoor Playground Arcade", icon: "üß©" }
        ],
        'food': [
            // ü•¨ [Êñ∞Â¢û] ÂÇ≥Áµ±Â∏ÇÂ†¥/Êó©Â∏Ç/È≠öÂ∏ÇÂ†¥ (ÈÅ©ÂêàÂè∞ÁÅ£ËàáÊó•Êú¨)
            { name: "ÂÇ≥Áµ±Â∏ÇÂ†¥", query: "ÂÇ≥Áµ±Â∏ÇÂ†¥ ËßÄÂÖâÂ∏ÇÂ†¥ ÈªÉÊòèÂ∏ÇÂ†¥ È≠öÂ∏ÇÂ†¥ Êó©Â∏Ç Market Morning Market Fish Market Farmers Market", icon: "ü•¨" },

            { name: "Êó•ÂºèÊñôÁêÜ", query: "Êó•ÂºèÊñôÁêÜ Â£ΩÂè∏ Ëø¥ËΩâÂ£ΩÂè∏ ËóèÂ£ΩÂè∏ Â£ΩÂè∏ÈÉé ÁÉèÈæçÈ∫µ ÊãâÈ∫µ Japanese Restaurant Sushi Ramen", icon: "üç£" }, 
            { name: "Ë¶™Â≠êÂØµÁâ©", query: "Ë¶™Â≠êÈ§êÂª≥ ÂØµÁâ©ÂèãÂñÑÈ§êÂª≥ Pet Friendly Restaurant", icon: "üê∂" }, 
            { name: "ÂìÅËå∂ËÅäÂ§©", query: "Ëå∂È§® Ê≥°Ê≤´Á¥ÖËå∂ ‰∫∫ÊñáËå∂È§® Êò•Ê∞¥Â†Ç ËÄïËÆÄÂúí Tea House", icon: "ü´ñ" },
            { name: "ÊâãÊêñÈ£≤Êñô", query: "È£≤ÊñôÂ∫ó ÊâãÊêñÊùØ Bubble Tea Drinks Juice Bar", icon: "ü•§" },
            { name: "ÂíñÂï°ÁîúÈªû", query: "ÂíñÂï°Âª≥ ÁîúÈªû ‰∏ãÂçàËå∂ Cafe Dessert Bakery", icon: "‚òï" },
            { name: "ÈÖíÂêßÂ±ÖÈÖíÂ±ã", query: "ÈÖíÂêß Â±ÖÈÖíÂ±ã È§êÈÖíÈ§® Bar Izakaya Pub", icon: "üç∫" },
            { name: "Áæ©ÂºèÊñôÁêÜ", query: "Áæ©Â§ßÂà©È∫µ Áæ©ÂºèÈ§êÂª≥ Êä´Ëñ© Italian Restaurant Pizza Pasta", icon: "üçù" },
            { name: "Ê≥ïÂºèÊñôÁêÜ", query: "Ê≥ïÂºèÈ§êÂª≥ French Restaurant Bistro", icon: "üç∑" },
            { name: "Âú®Âú∞Â∞èÂêÉ", query: "Â∞èÂêÉ È∫µÂ∫ó Local Food Street Food Market", icon: "üçú" },
            { name: "ÁÅ´ÈçãÁáíËÇâ", query: "ÁÅ´Èçã ÁáíËÇâ È∫ªËæ£Èçã Hotpot BBQ Yakiniku", icon: "üî•" },
            { name: "Êó©ÂçàÈ§ê", query: "Êó©ÂçàÈ§ê ËºïÈ£ü ‰∏âÊòéÊ≤ª Brunch Breakfast Sandwich", icon: "üç≥" }
        ],
        'medical': [
            // üè• [‰øÆÊ≠£] ÂÑ™ÂÖàÊêúÂ∞ãÊÄ•Ë®∫ÂÆ§
            { name: "ÊÄ•Ë®∫ÈÜ´Èô¢", query: "ÈÜ´Èô¢ ÊÄ•Ë®∫ÂÆ§ 24Â∞èÊôÇ Hospital Emergency Room 24H", icon: "üè•" },
            { name: "Â∞èÂÖíÁßë", query: "Â∞èÂÖíÁßëË®∫ÊâÄ Pediatrician", icon: "üë∂" },
            { name: "ËÄ≥ÈºªÂñâÁßë", query: "ËÄ≥ÈºªÂñâÁßëË®∫ÊâÄ ENT Clinic", icon: "üëÇ" },
            { name: "‰∏ÄËà¨Ë®∫ÊâÄ", query: "Ë®∫ÊâÄ ÂÖßÁßë Clinic Doctor Medical Center", icon: "ü©∫" },
            { name: "Ëó•Â±Ä", query: "Ëó•Â±Ä Pharmacy Drugstore Chemist", icon: "üíä" }
        ],
        'life': [
            // üè™ [‰øÆÊ≠£] Âä†ÂÖ• 7-11, ÂÖ®ÂÆ∂, Lawson ÈóúÈçµÂ≠óÔºåÁ¢∫‰øùÊúÄËøëÁöÑÂ∫óÂÆ∂Âá∫Áèæ
            { name: "‰æøÂà©Ë∂ÖÂïÜ", query: "‰æøÂà©ÂïÜÂ∫ó 7-Eleven ÂÖ®ÂÆ∂ ËêäÁàæÂØå OKË∂ÖÂïÜ Convenience Store 7-11 FamilyMart Lawson", icon: "üè™" },
            { name: "Ë∂ÖÂ∏ÇÈáèË≤©", query: "Ë∂ÖÂ∏Ç ÈáèË≤©Â∫ó ÂÖ®ËÅØ ÂÆ∂Ê®ÇÁ¶è Â•ΩÂ∏ÇÂ§ö Supermarket Hypermarket Grocery Store Costco Carrefour", icon: "üõí" },
            { name: "ÂªÅÊâÄ", query: "ÂÖ¨ÂªÅ Public Toilet Restroom WC", icon: "üöæ" }, 
            { name: "ÂÅúËªäÂ†¥", query: "ÂÅúËªäÂ†¥ Parking Lot Car Park", icon: "üÖøÔ∏è" },
            { name: "Âä†Ê≤πÁ´ô", query: "Âä†Ê≤πÁ´ô Gas Station Petrol Station", icon: "‚õΩ" }
        ]
    };

    window.onload = () => { 
        renderSubNav('fun'); 
        initUserLocation(); 
    };

    function initUserLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    userLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
                    document.getElementById('map-wrapper').classList.add('show');
                    document.getElementById('results').innerHTML = '<div class="empty-state"><p>Location Found!<br>Select a category to start.</p></div>';
                    await initMap(userLocation.lat, userLocation.lng);
                },
                (error) => {
                    document.getElementById('results').innerHTML = '<div class="empty-state">LOCATION ACCESS DENIED OR TIMEOUT</div>';
                },
                { timeout: 8000, maximumAge: 60000 } 
            );
        } else {
            document.getElementById('results').innerHTML = '<div class="empty-state">Geolocation Not Supported</div>';
        }
    }

    function toggleOpenFilter() {
        isOnlyOpen = !isOnlyOpen;
        const btn = document.getElementById('openFilterBtn');
        if(isOnlyOpen) btn.classList.add('active');
        else btn.classList.remove('active');
        renderPlacesList(allFetchedPlaces);
    }

    function selectCategory(cat) {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        renderSubNav(cat);
    }

    function renderSubNav(cat) {
        const container = document.getElementById('sub-nav');
        container.innerHTML = '';
        CATEGORIES[cat].forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'chip-btn';
            btn.innerHTML = `${opt.icon} ${opt.name}`;
            btn.onclick = () => startSearch(opt.query, btn);
            container.appendChild(btn);
        });
    }

    function refreshSearch() {
        const select = document.getElementById('radiusSelect');
        currentRadius = parseInt(select.value);
        if(currentQuery && userLocation) {
            const activeBtn = document.querySelector('.chip-btn.active');
            if(activeBtn) {
                const resultsDiv = document.getElementById('results');
                resultsDiv.innerHTML = '<div class="empty-state"><p>REFRESHING RADIUS...</p></div>';
                performSearch(userLocation, currentQuery, currentRadius);
            }
        }
    }

    function startSearch(query, btnElement) {
        document.querySelectorAll('.chip-btn').forEach(b => b.classList.remove('active'));
        btnElement.classList.add('active');
        
        currentQuery = query; 
        
        const select = document.getElementById('radiusSelect');
        currentRadius = parseInt(select.value);

        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = '<div class="empty-state"><p>SCANNING AREA...</p></div>';
        
        clearMarkers();
        allFetchedPlaces = []; 

        if (userLocation) {
             performSearch(userLocation, query, currentRadius);
        } else {
             initUserLocation(); 
        }
    }

    async function initMap(lat, lng) {
        const { Map } = await google.maps.importLibrary("maps");
        const center = { lat: lat, lng: lng };
        if (!map) {
            map = new Map(document.getElementById("map"), {
                center: center, zoom: 14, mapId: "DEMO_MAP_ID", disableDefaultUI: true,
                styles: [ { elementType: "geometry", stylers: [{ color: "#242f3e" }] }, { elementType: "labels.text.stroke", stylers: [{ color: "#242f3e" }] }, { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] } ]
            });
        } else {
            map.setCenter(center);
        }
        
        if(userMarker) userMarker.setMap(null);
        
        userMarker = new google.maps.Marker({
            position: center, map: map,
            icon: { path: google.maps.SymbolPath.CIRCLE, scale: 7, fillColor: "#3B82F6", fillOpacity: 1, strokeWeight: 2, strokeColor: "white" }
        });
    }

    function clearMarkers() {
        currentMarkers.forEach(m => m.setMap(null));
        currentMarkers = [];
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; 
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c; 
    }

    async function performSearch(location, query, radius) {
        const { Place } = await google.maps.importLibrary("places");
        const resultsDiv = document.getElementById('results');

        try {
            const request = {
                textQuery: query,
                fields: ['displayName', 'location', 'businessStatus', 'rating', 'userRatingCount', 'formattedAddress', 'id', 'reviews', 'types', 'regularOpeningHours'],
                locationBias: { center: location, radius: radius }, 
                maxResultCount: 20,
            };

            const { places } = await Place.searchByText(request);

            if (places && places.length > 0) {
                
                let filtered = places.filter(p => {
                    const name = (p.displayName || "").toLowerCase();
                    const types = p.types || [];
                    
                    const isSearchingForPets = query.includes('ÂØµÁâ©') || query.includes('Pet');
                    if (!isSearchingForPets) {
                        if (types.includes('veterinary_care') || types.includes('animal_hospital') || name.includes('ÂãïÁâ©ÈÜ´Èô¢') || name.includes('Áç∏ÈÜ´')) {
                            return false;
                        }
                    }

                    if (query.includes("ÈÜ´Â≠∏‰∏≠ÂøÉ") || query.includes("Hospital")) {
                        if ((name.includes("Ë®∫ÊâÄ") || name.includes("Clinic")) && !name.includes("Hospital")) {
                            return false; 
                        }
                        if (types.includes('dentist') || types.includes('physiotherapist')) return false;
                    }

                    return true;
                });
                
                let processedPlaces = filtered.map(place => {
                    if (place.location && userLocation) {
                        const dist = calculateDistance(
                            userLocation.lat, userLocation.lng,
                            place.location.lat(), place.location.lng()
                        );
                        place.distanceVal = dist;
                    } else {
                        place.distanceVal = 9999;
                    }
                    return place;
                });

                const maxKm = radius / 1000;
                allFetchedPlaces = processedPlaces.filter(p => p.distanceVal <= (maxKm * 1.5));
                allFetchedPlaces.sort((a, b) => a.distanceVal - b.distanceVal);

                renderPlacesList(allFetchedPlaces);

            } else {
                resultsDiv.innerHTML = '<div class="empty-state">NO LOCATIONS FOUND</div>';
            }
        } catch (e) {
            console.error(e);
            resultsDiv.innerHTML = '<div class="empty-state">API ERROR (CHECK CONSOLE)</div>';
        }
    }

    function renderPlacesList(places) {
        const resultsDiv = document.getElementById('results');
        clearMarkers();
        resultsDiv.innerHTML = "";

        let displayList = places;
        if (isOnlyOpen) {
            displayList = places.filter(p => p.businessStatus === 'OPERATIONAL');
        }

        if (displayList.length === 0) {
            resultsDiv.innerHTML = '<div class="empty-state">ÁØÑÂúçÂÖßÊâæ‰∏çÂà∞Âú∞Èªû (Ë©¶Ë©¶Â¢ûÂä†Ë∑ùÈõ¢?)</div>';
            return;
        }

        resultsDiv.innerHTML = `<div style="text-align:center; font-size:12px; color:#64748B; margin:10px 0;">FOUND: ${displayList.length} LOCATIONS</div>`;

        const bounds = new google.maps.LatLngBounds();
        if(userLocation) bounds.extend(userLocation);

        displayList.forEach((place, index) => {
            try {
                createPlaceCard(place, index);
                
                const marker = new google.maps.Marker({
                    position: place.location, map: map,
                    label: { text: (index+1).toString(), color: "white", fontSize: "12px" }
                });

                marker.addListener("click", () => {
                    const cards = document.querySelectorAll('.place-card');
                    if(cards[index]) {
                        cards[index].scrollIntoView({ behavior: 'smooth', block: 'center' });
                        cards[index].style.borderColor = '#3B82F6';
                        setTimeout(() => cards[index].style.borderColor = 'rgba(255,255,255,0.05)', 2000);
                    }
                });

                currentMarkers.push(marker);
                bounds.extend(place.location);

            } catch (err) {
                console.warn("Skipping bad place:", err);
            }
        });

        if (map && displayList.length > 0) {
            map.fitBounds(bounds);
            const listener = google.maps.event.addListener(map, "idle", function() { 
                if (map.getZoom() > 16) map.setZoom(16); 
                google.maps.event.removeListener(listener); 
            });
        }
    }

    function createPlaceCard(place, index) {
        const resultsDiv = document.getElementById('results');
        
        const name = place.displayName || "Unknown Place";
        const rating = place.rating ? place.rating.toFixed(1) : "N/A";
        const address = place.formattedAddress || "Address not provided";
        
        const isOpen = place.businessStatus === 'OPERATIONAL';
        const statusHtml = isOpen 
            ? `<span class="dot-open"></span> Open` 
            : `<span class="dot-close"></span> Closed`;

        let hoursText = "";
        if (place.regularOpeningHours && place.regularOpeningHours.weekdayDescriptions) {
            const todayIndex = (new Date().getDay() + 6) % 7; 
            hoursText = place.regularOpeningHours.weekdayDescriptions[todayIndex] || "";
        }

        let distDisplay = "";
        if (place.distanceVal) {
            if (place.distanceVal < 1) {
                distDisplay = `<span class="dist-badge">${Math.round(place.distanceVal * 1000)}m</span>`;
            } else {
                distDisplay = `<span class="dist-badge">${place.distanceVal.toFixed(1)}km</span>`;
            }
        }

        const isLowRating = place.rating && place.rating < 4.0;
        let ratingBadgeClass = isLowRating ? 'rating-badge low' : 'rating-badge';
        let ratingLabel = isLowRating ? '<span style="font-size:10px; margin-left:4px; opacity:0.8">‚ö†Ô∏è Low Rating</span>' : '';

        let extraTag = "";
        if (place.types && place.types.includes('hospital') && !name.includes('Ë®∫ÊâÄ') && !name.includes('Clinic')) {
             extraTag = `<span style="font-size:12px; color:#A78BFA; background:rgba(139,92,246,0.15); padding:2px 6px; border-radius:4px; margin-right:6px;">üè• Hospital</span>`;
        }

        let reviewHtml = '';
        if (place.reviews && place.reviews.length > 0) {
            let targetReview = place.reviews[0];
            if (isLowRating) {
                const badReview = place.reviews.find(r => r.rating <= 3);
                if (badReview) targetReview = badReview;
            }
            const rawText = targetReview.text || ""; 
            const text = rawText.length > 65 ? rawText.substring(0, 65) + "..." : rawText;
            
            if(text.trim().length > 0) {
                const reviewBoxClass = isLowRating ? 'review-box low' : 'review-box';
                const reviewTitle = isLowRating ? '‚ö†Ô∏è Critical Review' : 'üí¨ Review';
                reviewHtml = `<div class="${reviewBoxClass}"><div class="review-label">${reviewTitle}</div><div class="review-text">"${text}"</div></div>`;
            }
        }

        const card = document.createElement('div');
        card.className = 'place-card';
        card.style.animationDelay = `${index * 0.05}s`;
        
        card.innerHTML = `
            <div class="card-top">
                <div class="place-name">${index+1}. ${name}</div>
                <div class="${ratingBadgeClass}">‚òÖ ${rating} ${ratingLabel}</div>
            </div>
            
            <div class="status-row">
                ${distDisplay} ${extraTag} ${statusHtml} ‚Ä¢ ${address}
            </div>
            ${hoursText ? `<span class="hours-text">${hoursText}</span>` : ''}
            ${reviewHtml}

            <button class="nav-btn" onclick="openGoogleMaps('${place.id}', '${name.replace(/'/g, "\\'")}')">NAVIGATE ‚ûî</button>
        `;

        resultsDiv.appendChild(card);
    }

    function openGoogleMaps(placeId, name) {
        const encodedName = encodeURIComponent(name);
        const url = `https://www.google.com/maps/dir/?api=1&destination=${encodedName}&destination_place_id=${placeId}`;
        window.open(url, '_blank');
    }
</script>

</body>
</html>
