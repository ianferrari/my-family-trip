<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Travel OS - Open Source</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <style>
        :root {
            --bg-dark: #050505;
            --glass-panel: rgba(20, 20, 25, 0.85);
            --glass-border: rgba(255, 255, 255, 0.1);
            --neon-accent: #00f3ff; /* æ”¹ç‚ºæ›´æœ‰ç§‘æŠ€æ„Ÿçš„é’è‰² */
            --neon-warn: #ff0055;
            --neon-success: #00ff9d;
            --text-primary: #FFFFFF;
            --text-secondary: #888888;
            --card-radius: 20px;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-dark); 
            /* èƒŒæ™¯æ”¹ç‚ºç¶²æ ¼ï¼Œæ›´æœ‰é§­å®¢æ„Ÿ */
            background-image: 
                linear-gradient(rgba(0, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            margin: 0; padding: 0; 
            color: var(--text-primary); 
            padding-bottom: 100px;
        }
        
        /* ğŸŒ€ Header */
        header { 
            background: rgba(10, 10, 10, 0.8); 
            backdrop-filter: blur(15px);
            margin: 16px; padding: 16px 24px; 
            border-radius: 30px; border: 1px solid var(--glass-border);
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            position: sticky; top: 16px; z-index: 1000; /* Leaflet éœ€è¦æ¯”è¼ƒé«˜çš„ z-index */
        }
        header h1 { margin: 0; font-size: 20px; font-weight: 900; letter-spacing: 1px; color: #fff; text-shadow: 0 0 10px rgba(255,255,255,0.3); }
        .header-dot { width: 8px; height: 8px; background: var(--neon-success); border-radius: 50%; box-shadow: 0 0 10px var(--neon-success); animation: pulse 2s infinite; }
        
        /* ğŸ”˜ Tabs */
        .main-tabs { 
            display: flex; margin: 10px 16px; 
            background: rgba(30, 30, 35, 0.6); 
            padding: 5px; border-radius: 32px; 
            border: 1px solid var(--glass-border);
        }
        .tab-btn { 
            flex: 1; border: none; background: transparent; color: var(--text-secondary); 
            padding: 10px 0; border-radius: 26px; font-size: 13px; font-weight: 600; 
            cursor: pointer; transition: all 0.3s;
        }
        .tab-btn.active { background: #333; color: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        
        /* ğŸ’Š Chips */
        .sub-nav-container { margin: 0; overflow: hidden; padding: 10px 0; }
        .sub-scroll-wrapper { display: flex; gap: 10px; overflow-x: auto; padding: 0 20px 10px 20px; scrollbar-width: none; }
        .sub-scroll-wrapper::-webkit-scrollbar { display: none; }

        .chip-btn { 
            border: 1px solid var(--glass-border); background: rgba(30,30,35, 0.6); color: #ccc;
            padding: 8px 18px; font-size: 12px; font-weight: 500; border-radius: 100px; 
            white-space: nowrap; cursor: pointer; transition: all 0.2s;
        }
        .chip-btn.active { background: var(--neon-accent); color: #000; border-color: var(--neon-accent); font-weight: 800; box-shadow: 0 0 15px rgba(0, 243, 255, 0.4); }

        /* ğŸ—ºï¸ Map (Leaflet) */
        .map-wrapper { padding: 0 16px; margin: 10px 0 24px 0; position: relative; z-index: 0; }
        #map { width: 100%; height: 35vh; border-radius: var(--card-radius); border: 1px solid var(--glass-border); filter: grayscale(20%) contrast(1.1); }
        
        /* ğŸƒ Cards */
        .results-container { padding: 0 16px; max-width: 600px; margin: 0 auto; }
        .place-card { 
            background: var(--glass-panel); border: 1px solid var(--glass-border); 
            border-radius: var(--card-radius); padding: 20px; margin-bottom: 16px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: slideIn 0.4s ease-out forwards;
            position: relative; overflow: hidden;
        }
        
        /* è£é£¾ç·šæ¢ */
        .place-card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%;
            background: var(--neon-accent); opacity: 0.5;
        }

        .place-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .place-name { font-size: 18px; font-weight: 700; color: #fff; width: 70%; line-height: 1.4; }
        
        .tag-badge { 
            padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700; 
            background: rgba(255,255,255,0.1); color: var(--neon-accent); border: 1px solid rgba(0, 243, 255, 0.2);
            display: flex; align-items: center; gap: 4px;
        }

        .place-meta { font-size: 12px; color: var(--text-secondary); margin-bottom: 16px; display: flex; flex-direction: column; gap: 4px; }
        
        .action-btn {
            display: block; width: 100%; text-align: center; 
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            color: #fff; padding: 12px 0; border-radius: 12px;
            font-size: 13px; font-weight: 600; text-decoration: none; transition: all 0.2s;
        }
        .action-btn:hover { background: var(--neon-accent); color: #000; border-color: var(--neon-accent); }

        #status { text-align: center; margin: 10px 0; font-size: 10px; color: var(--neon-success); letter-spacing: 2px; text-transform: uppercase; }
        
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(0, 255, 157, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(0, 255, 157, 0); } 100% { box-shadow: 0 0 0 0 rgba(0, 255, 157, 0); } }
        
        /* éš±è— Leaflet ç‰ˆæ¬Šæ¨™ç¤ºä»¥ä¿æŒä»‹é¢ä¹¾æ·¨ (å¯é¸) */
        .leaflet-control-attribution { font-size: 9px !important; opacity: 0.5; background: transparent !important; color: #666 !important; }
    </style>
</head>
<body>

<header>
    <div>
        <h1>OSM <span style="font-weight:300; opacity:0.7">Scanner</span></h1>
        <p style="margin:2px 0 0; font-size:10px; color:#666;">FREE / OPEN SOURCE / NO-LIMIT</p>
    </div>
    <div class="header-dot"></div>
</header>

<div class="main-tabs">
    <button class="tab-btn active" onclick="selectCategory('fun')">ç©æ¨‚</button>
    <button class="tab-btn" onclick="selectCategory('food')">ç¾é£Ÿ</button>
    <button class="tab-btn" onclick="selectCategory('medical')">å¥åº·</button>
    <button class="tab-btn" onclick="selectCategory('life')">ç”Ÿæ´»</button>
</div>

<div class="sub-nav-container">
    <div class="sub-scroll-wrapper" id="sub-nav"></div>
</div>

<div id="status">SYSTEM ONLINE</div>

<div class="map-wrapper">
    <div id="map"></div>
</div>

<div class="results-container" id="results">
    <div style="text-align: center; margin-top: 40px; opacity: 0.4;">
        <p>INITIATE SCAN...</p>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
    // ğŸ› ï¸ é€™è£¡ä¸ä½¿ç”¨ Google APIï¼Œæ”¹ç”¨ Leaflet + Overpass API
    let map;
    let userMarker;
    let placeMarkers = [];
    let userLat = 25.0330; // é è¨­å°åŒ— (æœƒè¢« GPS è¦†è“‹)
    let userLng = 121.5654;

    // ğŸ—ºï¸ å®šç¾©æœå°‹æ¨™ç±¤ (Mapping åˆ° OSM çš„ tags)
    // é€™è£¡æ˜¯é—œéµï¼šå°‡æ‚¨çš„ä¸­æ–‡éœ€æ±‚è½‰æ›ç‚º OpenStreetMap çš„æ©Ÿå™¨èªè¨€
    const CATEGORIES = {
        'fun': [
            { name: "å…¬åœ’ç¶ åœ°", osm_tag: 'leisure=park', icon: "ğŸŒ³" },
            { name: "éŠæ¨‚å ´", osm_tag: 'leisure=playground', icon: "ğŸ›" },
            { name: "åšç‰©é¤¨", osm_tag: 'tourism=museum', icon: "ğŸ›ï¸" },
            { name: "æ™¯é»", osm_tag: 'tourism=attraction', icon: "ğŸ“¸" },
            { name: "åœ–æ›¸é¤¨", osm_tag: 'amenity=library', icon: "ğŸ“š" }
        ],
        'food': [
            { name: "é¤å»³", osm_tag: 'amenity=restaurant', icon: "ğŸ´" },
            { name: "å’–å•¡å»³", osm_tag: 'amenity=cafe', icon: "â˜•" },
            { name: "é€Ÿé£Ÿ", osm_tag: 'amenity=fast_food', icon: "ğŸ”" },
            { name: "é…’å§", osm_tag: 'amenity=bar', icon: "ğŸ¸" }
        ],
        'medical': [
            { name: "è¨ºæ‰€", osm_tag: 'amenity=clinic', icon: "ğŸ©º" },
            { name: "é†«é™¢", osm_tag: 'amenity=hospital', icon: "ğŸ¥" },
            { name: "è—¥å±€", osm_tag: 'amenity=pharmacy', icon: "ğŸ’Š" },
            { name: "ç‰™é†«", osm_tag: 'amenity=dentist', icon: "ğŸ¦·" }
        ],
        'life': [
            { name: "ä¾¿åˆ©å•†åº—", osm_tag: 'shop=convenience', icon: "ğŸª" },
            { name: "è¶…å¸‚", osm_tag: 'shop=supermarket', icon: "ğŸ›’" },
            { name: "åŠ æ²¹ç«™", osm_tag: 'amenity=fuel', icon: "â›½" },
            { name: "åœè»Šå ´", osm_tag: 'amenity=parking', icon: "ğŸ…¿ï¸" },
            { name: "éŠ€è¡Œ", osm_tag: 'amenity=bank', icon: "ğŸ’°" }
        ]
    };

    window.onload = () => { 
        initMap(); 
        renderSubNav('fun'); 
        getLocation(); // å•Ÿå‹•æ™‚æŠ“å–ä½ç½®
    };

    function selectCategory(cat) {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.currentTarget.classList.add('active');
        renderSubNav(cat);
    }

    function renderSubNav(cat) {
        const container = document.getElementById('sub-nav');
        container.innerHTML = '';
        CATEGORIES[cat].forEach((opt) => {
            const btn = document.createElement('button');
            btn.className = 'chip-btn';
            btn.innerHTML = `${opt.icon} ${opt.name}`;
            btn.onclick = () => startOverpassSearch(opt.osm_tag, btn);
            container.appendChild(btn);
        });
    }

    // 1ï¸âƒ£ åˆå§‹åŒ– Leaflet åœ°åœ– (ä½¿ç”¨å…è²»çš„ CartoDB Dark Matter åœ–å±¤)
    function initMap() {
        map = L.map('map', { zoomControl: false }).setView([userLat, userLng], 15);
        
        // ä½¿ç”¨ CartoDB çš„æš—è‰²ç³»åœ–ç£š (å¾ˆæœ‰è³ªæ„Ÿä¸”å…è²»)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CARTO',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);
    }

    // 2ï¸âƒ£ ç²å– GPS
    function getLocation() {
        if (navigator.geolocation) {
            document.getElementById('status').innerText = "ACQUIRING GPS SIGNAL...";
            navigator.geolocation.getCurrentPosition(position => {
                userLat = position.coords.latitude;
                userLng = position.coords.longitude;
                
                // æ›´æ–°åœ°åœ–ä¸­å¿ƒ
                map.setView([userLat, userLng], 16);
                
                // ç¹ªè£½ä½¿ç”¨è€…ä½ç½® (è—è‰²è„ˆè¡é»)
                if(userMarker) map.removeLayer(userMarker);
                
                const pulseIcon = L.divIcon({
                    className: 'user-pulse',
                    html: '<div style="width:12px;height:12px;background:#00f3ff;border-radius:50%;box-shadow:0 0 15px #00f3ff;border:2px solid #fff;"></div>',
                    iconSize: [16, 16]
                });
                
                userMarker = L.marker([userLat, userLng], {icon: pulseIcon}).addTo(map);
                document.getElementById('status').innerText = "GPS LOCKED - READY";
            }, () => {
                document.getElementById('status').innerText = "GPS ERROR - USING DEFAULT";
            });
        }
    }

    // 3ï¸âƒ£ æ ¸å¿ƒï¼šä½¿ç”¨ Overpass API é€²è¡Œå…è²»æœå°‹
    async function startOverpassSearch(osmTag, btnElement) {
        // UI æ›´æ–°
        document.querySelectorAll('.chip-btn').forEach(b => b.classList.remove('active'));
        btnElement.classList.add('active');
        const statusDiv = document.getElementById('status');
        const resultsDiv = document.getElementById('results');
        
        statusDiv.innerText = "QUERYING SATELLITE DATA...";
        resultsDiv.innerHTML = '<div style="text-align:center; padding:30px; color:#666;">Scanning sector...</div>';
        
        // æ¸…é™¤èˆŠæ¨™è¨˜
        placeMarkers.forEach(m => map.removeLayer(m));
        placeMarkers = [];

        // å»ºæ§‹ Overpass QL æŸ¥è©¢èªæ³•
        // æœå°‹åŠå¾‘ 1500 å…¬å°ºå…§çš„ç¯€é»(node)èˆ‡è·¯å¾‘(way)
        const radius = 1500;
        const [key, value] = osmTag.split('=');
        
        // é€™æ˜¯å‘ OSM ä¼ºæœå™¨ç™¼é€çš„æŒ‡ä»¤
        const query = `
            [out:json][timeout:25];
            (
              node["${key}"="${value}"](around:${radius},${userLat},${userLng});
              way["${key}"="${value}"](around:${radius},${userLat},${userLng});
            );
            out body;
            >;
            out skel qt;
        `;

        try {
            // ç™¼é€è«‹æ±‚åˆ° Overpass API (å®Œå…¨å…è²»çš„å…¬é–‹æ¥å£)
            const response = await fetch('https://overpass-api.de/api/interpreter', {
                method: 'POST',
                body: query
            });
            const data = await response.json();
            
            displayOverpassResults(data.elements, key, value);
            statusDiv.innerText = "DATA RECEIVED";

        } catch (error) {
            console.error(error);
            resultsDiv.innerHTML = '<div style="text-align:center; color:#ff0055;">CONNECTION LOST<br>Try again later</div>';
            statusDiv.innerText = "NETWORK ERROR";
        }
    }

    // 4ï¸âƒ£ é¡¯ç¤ºçµæœ
    function displayOverpassResults(elements, searchKey, searchValue) {
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = "";

        // éæ¿¾æ‰æ²’æœ‰åå­—çš„åœ°é» (å¾ˆå¤š OSM è³‡æ–™åªæœ‰åº§æ¨™æ²’åå­—)
        // ä¸¦åªå– node (é») æˆ– way (å»ºç¯‰ç‰©ä¸­å¿ƒ)
        const validPlaces = elements.filter(el => el.tags && el.tags.name);
        
        if (validPlaces.length === 0) {
            resultsDiv.innerHTML = '<div style="text-align:center; padding:40px; opacity:0.5;">NO TARGETS FOUND IN SECTOR</div>';
            return;
        }

        // è¨ˆç®—è·é›¢ä¸¦æ’åº
        validPlaces.forEach(place => {
            // å¦‚æœæ˜¯ way (å»ºç¯‰ç‰©)ï¼Œé€šå¸¸æ²’æœ‰ç›´æ¥åº§æ¨™ï¼Œé€™è£¡ç°¡åŒ–è™•ç†ï¼Œè‹¥ç„¡ lat/lon å‰‡å¿½ç•¥æˆ–éœ€è¨ˆç®—ä¸­å¿ƒé»
            // ç‚ºæ±‚ç°¡å–®ï¼Œæˆ‘å€‘ç›¡é‡å–æœ‰ lat/lon çš„è³‡æ–™ (Overpass çš„ center åŠŸèƒ½éœ€è¦æ›´è¤‡é›œæŸ¥è©¢ï¼Œé€™è£¡å…ˆåšç°¡æ˜“ç‰ˆ)
            if (!place.lat && !place.lon) return; 
            
            place.distance = getDistanceFromLatLonInKm(userLat, userLng, place.lat, place.lon);
        });

        // æŒ‰è·é›¢æ’åº
        validPlaces.sort((a, b) => a.distance - b.distance);

        validPlaces.forEach((place, index) => {
            if (index > 20) return; // åªé¡¯ç¤ºæœ€è¿‘ 20 ç­†

            // ç”¢ç”Ÿ Google Maps å°èˆªé€£çµ
            const navUrl = `https://www.google.com/maps/dir/?api=1&destination=${place.lat},${place.lon}`;
            
            const card = document.createElement('div');
            card.className = 'place-card';
            card.style.animationDelay = `${index * 0.05}s`;
            
            // ç”±æ–¼æ²’æœ‰è©•åˆ†ï¼Œæˆ‘å€‘é¡¯ç¤ºã€Œè·é›¢ã€å’Œã€Œé¡å‹ã€
            const distDisplay = place.distance < 1 ? `${(place.distance * 1000).toFixed(0)} m` : `${place.distance.toFixed(1)} km`;
            
            card.innerHTML = `
                <div class="place-header">
                    <div class="place-name">${place.tags.name}</div>
                    <div class="tag-badge">ğŸ“ ${distDisplay}</div>
                </div>
                <div class="place-meta">
                    <div>Type: ${place.tags[searchKey] || searchValue}</div>
                    <div style="opacity:0.6; font-size:10px; margin-top:4px;">COORD: ${place.lat.toFixed(4)}, ${place.lon.toFixed(4)}</div>
                </div>
                <a href="${navUrl}" target="_blank" class="action-btn">
                    INITIATE NAVIGATION âœ
                </a>
            `;
            resultsDiv.appendChild(card);

            // åœ°åœ–æ¨™è¨˜
            const marker = L.marker([place.lat, place.lon]).addTo(map)
                .bindPopup(`<b>${place.tags.name}</b><br>${distDisplay}`);
            placeMarkers.push(marker);
        });
    }

    // è¼”åŠ©ï¼šè¨ˆç®—è·é›¢ (Haversine å…¬å¼)
    function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
        var R = 6371; 
        var dLat = deg2rad(lat2-lat1);  
        var dLon = deg2rad(lon2-lon1); 
        var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
        var d = R * c; 
        return d;
    }
    function deg2rad(deg) { return deg * (Math.PI/180); }

</script>
</body>
</html>
