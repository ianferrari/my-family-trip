<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Travel OS</title>
    <style>
        :root {
            --ios-bg: #F2F2F7;
            --ios-card: #FFFFFF;
            --ios-blue: #007AFF;
            --ios-orange: #FF9500;
            --ios-red: #FF3B30;
            --ios-green: #34C759;
            --ios-purple: #AF52DE;
            --ios-gray-text: #8E8E93;
            --glass-material: rgba(255, 255, 255, 0.85);
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.06);
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif; background-color: var(--ios-bg); margin: 0; padding: 0; color: #1C1C1E; -webkit-tap-highlight-color: transparent; }
        
        header { background: var(--glass-material); backdrop-filter: saturate(180%) blur(20px); -webkit-backdrop-filter: saturate(180%) blur(20px); position: sticky; top: 0; z-index: 100; border-bottom: 0.5px solid rgba(0,0,0,0.1); padding: 12px 20px; }
        header h1 { margin: 0; font-size: 28px; font-weight: 800; letter-spacing: -0.5px; }
        header p { margin: 4px 0 0; font-size: 13px; color: var(--ios-gray-text); font-weight: 500; }
        
        .controls-container { padding: 12px 0 12px 20px; background: var(--ios-bg); overflow: hidden; }
        .btn-scroll-wrapper { 
            display: flex; gap: 12px; overflow-x: auto; padding-right: 20px; padding-bottom: 5px; 
            scrollbar-width: none; -ms-overflow-style: none; 
        }
        .btn-scroll-wrapper::-webkit-scrollbar { display: none; }

        button { 
            border: none; padding: 10px 16px; font-size: 14px; font-weight: 600; border-radius: 20px; 
            cursor: pointer; transition: all 0.2s; background: #E5E5EA; color: #8E8E93; white-space: nowrap; flex-shrink: 0; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        button:active { transform: scale(0.95); }

        button.active-fun { background: var(--ios-orange); color: white; box-shadow: 0 4px 10px rgba(255, 149, 0, 0.3); }
        button.active-food { background: var(--ios-green); color: white; box-shadow: 0 4px 10px rgba(52, 199, 89, 0.3); }
        button.active-snack { background: var(--ios-purple); color: white; box-shadow: 0 4px 10px rgba(175, 82, 222, 0.3); }
        button.active-bbq { background: var(--ios-red); color: white; box-shadow: 0 4px 10px rgba(255, 59, 48, 0.3); }
        button.active-bar { background: var(--ios-indigo); color: white; box-shadow: 0 4px 10px rgba(88, 86, 214, 0.3); }

        #status { text-align: center; margin-top: 5px; font-size: 12px; color: var(--ios-gray-text); font-weight: 500; min-height: 20px; margin-bottom: 10px;}
        
        .map-wrapper { padding: 0 20px; margin-bottom: 20px; }
        #map { width: 100%; height: 35vh; border-radius: 24px; box-shadow: var(--shadow-sm); background-color: #E5E5EA; }
        
        .results-container { padding: 0 20px 80px 20px; max-width: 600px; margin: 0 auto; }
        .place-card { background: var(--ios-card); border-radius: 20px; padding: 20px; margin-bottom: 16px; box-shadow: var(--shadow-sm); transition: transform 0.2s; border: 1px solid rgba(0,0,0,0.02); }
        .place-card:active { transform: scale(0.98); background-color: #F9F9F9; }
        .place-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .place-name { font-size: 18px; font-weight: 700; color: #000; line-height: 1.3; }
        .place-rating { background: #F2F2F7; color: var(--ios-orange); padding: 4px 10px; border-radius: 50px; font-size: 13px; font-weight: 700; flex-shrink: 0; margin-left: 8px;}
        .place-info { font-size: 14px; color: #8E8E93; margin-bottom: 12px; display: flex; align-items: center; gap: 6px; }
        
        .parent-tips { background-color: #F0F8FF; color: #004085; padding: 12px 16px; border-radius: 16px; font-size: 14px; line-height: 1.5; margin-top: 12px; }
        .food-tips { background-color: #E8F5E9; color: #2E7D32; }
        .snack-tips { background-color: #F3E5F5; color: #7B1FA2; }
        .bbq-tips { background-color: #FFEBEE; color: #C62828; }
        .bar-tips { background-color: #E8EAF6; color: #283593; }
        
        /* ä½åˆ†è­¦å‘Šæ¨£å¼ */
        .warning-text { color: #FF3B30; font-weight: bold; }

        /* è©•è«–å€å¡Šæ¨£å¼ */
        .review-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #F2F2F7;
            font-size: 13px;
            color: #3C3C43;
            font-style: italic;
        }
        .review-user {
            font-weight: 600;
            font-style: normal;
            font-size: 12px;
            color: #8E8E93;
            margin-bottom: 4px;
            display: block;
        }

        .tags { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 12px; }
        .tag { background: #F2F2F7; color: #8E8E93; font-size: 12px; font-weight: 600; padding: 6px 12px; border-radius: 100px; }
        .open-now { color: var(--ios-green); }
        .closed-now { color: var(--ios-red); }
        .empty-state { text-align: center; margin-top: 40px; color: #C7C7CC; }
        #debug-info { text-align: center; font-size: 10px; color: #ff3b30; margin-top: 20px; opacity: 0.7; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<header>
    <h1>Travel OS</h1>
    <p>Family Trip â€¢ Explorer</p>
</header>

<div class="controls-container">
    <div class="btn-scroll-wrapper">
        <button id="btn-fun" onclick="switchMode('fun')">ğŸ¡ æ‰¾å¥½ç©</button>
        <button id="btn-food" onclick="switchMode('food')">ğŸ‘¶ è¦ªå­é¤å»³</button>
        <button id="btn-bbq" onclick="switchMode('bbq')">ğŸ”¥ ç‡’è‚‰ç«é‹</button>
        <button id="btn-bar" onclick="switchMode('bar')">ğŸº å±…é…’å±‹</button>
        <button id="btn-snack" onclick="switchMode('snack')">ğŸœ åœ¨åœ°å°åƒ</button>
    </div>
</div>
<div id="status">Ready to explore</div>

<div class="map-wrapper">
    <div id="map"></div>
</div>

<div class="results-container" id="results">
    <div class="empty-state">
        <p>å·¦å³æ»‘å‹•ä¸Šæ–¹æŒ‰éˆ•<br>é¸æ“‡æƒ³å»çš„åœ°æ–¹</p>
    </div>
</div>

<div id="debug-info"></div>

<script src="https://maps.googleapis.com/maps/api/js?key=
AIzaSyClFqb1iWGHOvEPNLtA2-lHsQT844C4sqE&loading=async&libraries=places,maps"></script>

<script>
    let map;
    let userLocation = null;
    let currentMarkers = []; 
    let currentMode = null; 

    async function initMap(lat, lng) {
        const { Map } = await google.maps.importLibrary("maps");
        const center = { lat: lat, lng: lng };
        if (!map) {
            map = new Map(document.getElementById("map"), {
                center: center, zoom: 15, mapId: "DEMO_MAP_ID", disableDefaultUI: true, gestureHandling: "greedy"
            });
        } else {
            map.setCenter(center); map.setZoom(15);
        }
        new google.maps.Marker({
            position: center, map: map,
            icon: { path: google.maps.SymbolPath.CIRCLE, scale: 10, fillColor: "#007AFF", fillOpacity: 1, strokeWeight: 4, strokeColor: "white" },
            zIndex: 999 
        });
    }

    function clearMarkers() {
        currentMarkers.forEach(marker => marker.setMap(null));
        currentMarkers = [];
    }

    function switchMode(mode) {
        currentMode = mode;
        const btns = ['btn-fun', 'btn-food', 'btn-bbq', 'btn-bar', 'btn-snack'];
        document.getElementById('debug-info').innerText = ""; 
        document.getElementById('results').innerHTML = '<div class="empty-state"><p>Loading...</p></div>';
        clearMarkers();
        btns.forEach(id => { document.getElementById(id).className = ''; });
        document.getElementById('btn-' + mode).classList.add('active-' + mode);
        startExplore();
    }

    function startExplore() {
        if (!currentMode) return;
        const statusDiv = document.getElementById('status');
        statusDiv.innerHTML = "Locating...";
        
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    userLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
                    statusDiv.innerHTML = "Searching nearby...";
                    await initMap(userLocation.lat, userLocation.lng);
                    
                    if (currentMode === 'fun') await searchFunPlaces(userLocation);
                    else if (currentMode === 'food') await searchFoodWithFallback(userLocation, "è¦ªå­é¤å»³ å¯µç‰©å‹å–„ å®¶åº­é¤å»³");
                    else if (currentMode === 'bbq') await searchFoodWithFallback(userLocation, "ç‡’è‚‰ ç«é‹ éº»è¾£é‹ å£½å–œç‡’");
                    else if (currentMode === 'bar') await searchFoodWithFallback(userLocation, "å±…é…’å±‹ é…’å§ é¤é…’é¤¨");
                    else if (currentMode === 'snack') await searchLocalSnacks(userLocation);
                    
                    statusDiv.innerHTML = "Done";
                },
                (error) => { statusDiv.innerHTML = "âŒ GPS Error"; }
            );
        } else { statusDiv.innerHTML = "âŒ No GPS Support"; }
    }

    // ğŸ¡ æ‰¾å¥½ç©
    async function searchFunPlaces(location) {
        try {
            const { Place, SearchNearbyRankPreference } = await google.maps.importLibrary("places");
            // åŠ å…¥ 'reviews' æ¬„ä½
            const request = {
                fields: ['displayName', 'location', 'businessStatus', 'rating', 'types', 'formattedAddress', 'reviews'],
                locationRestriction: { center: location, radius: 1500 },
                includedPrimaryTypes: ['tourist_attraction', 'park', 'museum', 'shopping_mall', 'zoo', 'aquarium'],
                maxResultCount: 15,
                rankPreference: SearchNearbyRankPreference.POPULARITY,
                language: 'zh-TW',
            };
            const { places } = await Place.searchNearby(request);
            displayResults(places, 'fun');
        } catch (e) { handleError(e, "Fun Error"); }
    }

    // é€šç”¨æœå°‹å™¨
    async function searchFoodWithFallback(location, query) {
        const { Place } = await google.maps.importLibrary("places");
        try {
            const request = {
                textQuery: query, 
                fields: ['displayName', 'location', 'businessStatus', 'rating', 'types', 'formattedAddress', 'reviews'],
                locationBias: { center: location, radius: 1000 },
                maxResultCount: 15,
                language: 'zh-TW',
            };
            const { places } = await Place.searchByText(request);
            if (places && places.length > 0) {
                displayResults(places, currentMode);
                return;
            }
        } catch(e) { console.warn("Primary search failed", e); }

        try {
            const { SearchNearbyRankPreference } = await google.maps.importLibrary("places");
            const fallbackRequest = {
                fields: ['displayName', 'location', 'businessStatus', 'rating', 'types', 'formattedAddress', 'reviews'],
                locationRestriction: { center: location, radius: 1000 },
                includedPrimaryTypes: ['restaurant'], 
                maxResultCount: 15,
                rankPreference: SearchNearbyRankPreference.POPULARITY,
                language: 'zh-TW',
            };
            const { places } = await Place.searchNearby(fallbackRequest);
            displayResults(places, currentMode);
        } catch(e) { handleError(e, "Fallback Error"); }
    }

    // ğŸœ æ‰¾å°åƒ (èª¿æ•´é–€æª»è‡³ 3.5)
    async function searchLocalSnacks(location) {
        const { Place } = await google.maps.importLibrary("places");
        try {
            const request = {
                textQuery: "å¿…åƒç¾é£Ÿ åœ¨åœ°å°åƒ è€åº— çç å¥¶èŒ¶ èŒ¶é¤¨ ç”œé»", 
                fields: ['displayName', 'location', 'businessStatus', 'rating', 'types', 'formattedAddress', 'reviews'],
                locationBias: { center: location, radius: 1000 },
                maxResultCount: 15,
                language: 'zh-TW', 
                minRating: 3.5 // é–€æª»èª¿é™åˆ° 3.5
            };
            const { places } = await Place.searchByText(request);
            displayResults(places, 'snack');
        } catch (e) { handleError(e, "Snack Error"); }
    }

    function displayResults(places, mode) {
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = ""; 
        clearMarkers();

        const activePlaces = places.filter(p => p.businessStatus === 'OPERATIONAL' || !p.businessStatus);

        if (!activePlaces || activePlaces.length === 0) {
            resultsDiv.innerHTML = '<div class="empty-state"><p>é™„è¿‘æ²’æœ‰ç¬¦åˆçš„ç‡Ÿæ¥­åœ°é»</p></div>';
            return;
        }

        activePlaces.forEach((place, index) => {
            const name = place.displayName;
            const rating = place.rating || 0; // é¿å… null
            const address = place.formattedAddress ? place.formattedAddress.replace('å°ç£å°ä¸­å¸‚', '').replace(/^[0-9]+/, '') : "";
            const types = place.types || [];
            let openStatus = "<span class='open-now'>Open</span>";
            
            // è™•ç†è©•è«–
            let reviewHtml = "";
            if (place.reviews && place.reviews.length > 0) {
                const review = place.reviews[0]; // æŠ“æœ€æ–°æˆ–æœ€ç›¸é—œçš„ä¸€å‰‡
                const text = review.text ? (review.text.length > 60 ? review.text.substring(0, 60) + "..." : review.text) : "æš«ç„¡æ–‡å­—è©•è«–";
                reviewHtml = `
                    <div class="review-section">
                        <span class="review-user">ğŸ’¬ æœ€æ–°è©•è«–ï¼š</span>
                        "${text}"
                    </div>
                `;
            }

            // åˆ†æå»ºè­°èˆ‡ä½åˆ†è­¦å‘Š
            const advice = analyzeForParents(types, rating, mode);
            
            let tipClass = 'parent-tips';
            let icon = 'ğŸ“';
            if (mode === 'fun') { icon = 'ğŸ¡'; }
            else if (mode === 'food') { tipClass += ' food-tips'; icon = 'ğŸ‘¶'; }
            else if (mode === 'bbq') { tipClass += ' bbq-tips'; icon = 'ğŸ”¥'; }
            else if (mode === 'bar') { tipClass += ' bar-tips'; icon = 'ğŸº'; }
            else if (mode === 'snack') { tipClass += ' snack-tips'; icon = 'ğŸœ'; }

            const delay = index * 0.1;
            const card = document.createElement('div');
            card.className = 'place-card';
            card.style.animation = `fadeInUp 0.5s ease forwards ${delay}s`;
            card.innerHTML = `
                <div class="place-header">
                    <div class="place-name">${name}</div>
                    ${rating ? `<div class="place-rating">â˜… ${rating}</div>` : ''}
                </div>
                <div class="place-info">${openStatus} Â â€¢Â  ${address}</div>
                <div class="${tipClass}"><span class="tip-icon">${icon}</span> ${advice}</div>
                ${reviewHtml}
                <div class="tags">${types.slice(0, 3).map(type => `<span class="tag">${formatType(type)}</span>`).join('')}</div>
            `;
            
            card.onclick = () => {
                window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(name)}&query_place_id=${place.id}`, '_blank');
            };
            resultsDiv.appendChild(card);
            new google.maps.Marker({ position: place.location, map: map, title: name });
        });
    }

    function analyzeForParents(types, rating, mode) {
        let advice = "";
        
        // ä½åˆ†è­¦å‘Šé‚è¼¯
        if (rating < 4.0 && rating > 0) {
            advice = "<span class='warning-text'>âš ï¸ è©•åƒ¹ä½æ–¼ 4 åˆ†ï¼Œå»ºè­°åƒè€ƒä¸‹æ–¹è©•è«–ã€‚</span> ";
        }

        if (mode === 'bbq') {
            advice += "ç‚­ç«/ç†±æ¹¯è«‹æ³¨æ„ 3 æ­²å°å­©å®‰å…¨ã€‚";
        } 
        else if (mode === 'bar') {
            advice += "è«‹ç•™æ„åº—å…§æ˜¯å¦ç¦è¸ã€‚";
        }
        else if (mode === 'food') {
            if (!advice) advice = "é©åˆå¸¶å°å­©çš„é¤å»³ã€‚";
        }
        else if (mode === 'snack') {
            if (!advice) advice = "åœ¨åœ°äººæ°£å°åƒï¼";
        }
        else { // Fun
            if (!advice) advice = "ç†±é–€æ™¯é»ï¼Œè«‹ç•™æ„äººæ½®ã€‚";
        }
        return advice;
    }

    function formatType(type) {
        const dict = { 'tourist_attraction': 'æ™¯é»', 'park': 'å…¬åœ’', 'restaurant': 'é¤å»³', 'cafe': 'å’–å•¡', 'store': 'å•†åº—', 'food': 'ç¾é£Ÿ', 'bakery': 'çƒ˜ç„™', 'bar': 'é…’å§', 'night_club': 'å¤œåº—' };
        return dict[type] || 'åœ°é»';
    }
    
    function handleError(e, title) {
        console.error(e);
        document.getElementById('debug-info').innerText = title + ": " + e.message;
        document.getElementById('results').innerHTML = '<div class="empty-state"><p>æš«æ™‚ç„¡æ³•æœå°‹ï¼Œè«‹ç¨å¾Œå†è©¦</p></div>';
    }
</script>
</body>
</html>

