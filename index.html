<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Travel OS - Free V2</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root {
            --bg-dark: #050505;
            --glass-panel: rgba(20, 20, 25, 0.9);
            --neon-accent: #00f3ff;
            --neon-warn: #ff0055;
            --card-radius: 20px;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-dark); 
            background-image: radial-gradient(circle at 50% 50%, #111 0%, #000 100%);
            margin: 0; padding: 0; 
            color: #fff; 
            padding-bottom: 100px;
        }
        
        /* ä»‹é¢æ¨£å¼ */
        header { 
            background: rgba(20,20,20,0.8); backdrop-filter: blur(10px);
            margin: 16px; padding: 16px 24px; border-radius: 24px; border: 1px solid rgba(255,255,255,0.1);
            display: flex; justify-content: space-between; align-items: center;
        }
        
        .main-tabs { display: flex; gap: 8px; padding: 0 16px; margin-bottom: 10px; }
        .tab-btn { 
            flex: 1; background: #222; border: 1px solid #333; color: #888; 
            padding: 10px 0; border-radius: 12px; font-size: 13px; font-weight: 600;
        }
        .tab-btn.active { background: #333; color: #fff; border-color: #555; }

        .sub-scroll-wrapper { display: flex; gap: 10px; overflow-x: auto; padding: 10px 16px; }
        .chip-btn { 
            background: rgba(0, 243, 255, 0.1); border: 1px solid rgba(0, 243, 255, 0.3); color: var(--neon-accent);
            padding: 8px 16px; border-radius: 100px; white-space: nowrap; font-size: 12px;
        }
        .chip-btn.active { background: var(--neon-accent); color: #000; font-weight: bold; }

        #map { height: 35vh; margin: 0 16px; border-radius: 20px; border: 1px solid #333; filter: grayscale(100%) invert(100%) contrast(0.9); }
        /* åè½‰é¡è‰²è®“åŸæœ¬ç™½è‰²çš„åœ°åœ–è®Šæˆé»‘è‰²é¢¨æ ¼ï¼Œè§£æ±ºè®€å–å•é¡Œ */

        .place-card { 
            background: #111; border: 1px solid #333; border-radius: 16px; 
            padding: 16px; margin: 16px; position: relative;
        }
        .place-name { font-size: 16px; font-weight: bold; margin-bottom: 5px; color: #fff; }
        .place-info { font-size: 12px; color: #888; margin-bottom: 12px; }

        .btn-group { display: flex; gap: 10px; }
        .action-btn {
            flex: 1; text-align: center; padding: 10px; border-radius: 8px;
            font-size: 12px; font-weight: bold; text-decoration: none;
        }
        .btn-nav { background: var(--neon-accent); color: #000; }
        .btn-review { background: #333; color: #fff; border: 1px solid #555; }

        #status { text-align: center; font-size: 12px; color: #666; margin: 10px 0; }
    </style>
</head>
<body>

<header>
    <h3>OSM Scanner <span style="font-size:10px; opacity:0.5">V2.0</span></h3>
    <div style="width:8px; height:8px; background:#0f0; border-radius:50%;"></div>
</header>

<div class="main-tabs">
    <button class="tab-btn active" onclick="setCat('fun')">ç©æ¨‚</button>
    <button class="tab-btn" onclick="setCat('food')">ç¾é£Ÿ</button>
    <button class="tab-btn" onclick="setCat('medical')">é†«ç™‚</button>
</div>

<div class="sub-scroll-wrapper" id="sub-nav"></div>

<div id="status">READY</div>
<div id="map"></div>
<div id="results"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    let map, userMarker, userLat, userLng;
    // å‚™ç”¨ä¼ºæœå™¨åˆ—è¡¨ï¼Œå¦‚æœç¬¬ä¸€å€‹æ›äº†æœƒè©¦ç¬¬äºŒå€‹
    const API_SERVERS = [
        'https://overpass-api.de/api/interpreter',
        'https://maps.mail.ru/osm/tools/overpass/api/interpreter',
        'https://overpass.kumi.systems/api/interpreter'
    ];

    const CATS = {
        'fun': [
            {n:"å…¬åœ’", q:'leisure=park'}, {n:"ç™¾è²¨", q:'shop=department_store'}, 
            {n:"æ™¯é»", q:'tourism=attraction'}
        ],
        'food': [
            {n:"é¤å»³", q:'amenity=restaurant'}, {n:"å’–å•¡", q:'amenity=cafe'}, 
            {n:"é€Ÿé£Ÿ", q:'amenity=fast_food'}
        ],
        'medical': [
            {n:"é†«é™¢", q:'amenity=hospital'}, {n:"è¨ºæ‰€", q:'amenity=clinic'}, 
            {n:"è—¥å±€", q:'amenity=pharmacy'}
        ]
    };

    window.onload = () => {
        // åˆå§‹åŒ–åœ°åœ– (å…ˆç”¨é è¨­å°åŒ—ï¼Œç­‰GPS)
        map = L.map('map').setView([25.033, 121.565], 15);
        // ä½¿ç”¨æœ€æ¨™æº–çš„ OSM åœ–å±¤ï¼Œä½†é€é CSSæ¿¾é¡æŠŠå®ƒè®Šé»‘ï¼Œé€™æ¨£æœ€ç©©å®š
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19}).addTo(map);
        
        setCat('fun');
        
        if(navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                userLat = pos.coords.latitude;
                userLng = pos.coords.longitude;
                map.setView([userLat, userLng], 16);
                L.marker([userLat, userLng]).addTo(map).bindPopup("You are here").openPopup();
                document.getElementById('status').innerText = "GPS LOCKED";
            }, err => {
                document.getElementById('status').innerText = "GPS FAILED: " + err.message;
            });
        }
    };

    function setCat(key) {
        const div = document.getElementById('sub-nav');
        div.innerHTML = '';
        CATS[key].forEach(c => {
            const b = document.createElement('button');
            b.className = 'chip-btn';
            b.innerText = c.n;
            b.onclick = () => search(c.q, b);
            div.appendChild(b);
        });
    }

    async function search(queryStr, btn) {
        if(!userLat) { alert("ç­‰å¾… GPS å®šä½ä¸­..."); return; }
        
        document.querySelectorAll('.chip-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('status').innerText = "SCANNING...";
        document.getElementById('results').innerHTML = '<p style="text-align:center; padding:20px; color:#666">é€£ç·šä¸­...</p>';

        const [k, v] = queryStr.split('=');
        // æœå°‹åŠå¾‘ 1000 å…¬å°º
        const ql = `[out:json][timeout:10];(node["${k}"="${v}"](around:1000,${userLat},${userLng}););out;`;

        // å˜—è©¦è¼ªæµä½¿ç”¨ä¼ºæœå™¨
        let success = false;
        for (let server of API_SERVERS) {
            try {
                console.log("Trying server:", server);
                const res = await fetch(server, { method: 'POST', body: ql });
                if (!res.ok) throw new Error("Server blocked");
                const data = await res.json();
                render(data.elements);
                document.getElementById('status').innerText = "FOUND " + data.elements.length + " PLACES";
                success = true;
                break; // æˆåŠŸå°±è·³å‡ºè¿´åœˆ
            } catch (e) {
                console.warn("Server failed, trying next...", e);
            }
        }

        if (!success) {
            document.getElementById('status').innerText = "ALL SERVERS BUSY";
            document.getElementById('results').innerHTML = '<p style="text-align:center; color:#ff0055">ä¼ºæœå™¨å¿™ç¢Œä¸­ï¼Œè«‹ç¨å¾Œå†è©¦</p>';
        }
    }

    function render(list) {
        const div = document.getElementById('results');
        div.innerHTML = '';
        
        // éæ¿¾æ²’åå­—çš„ï¼Œä¸¦åªå–å‰ 15 ç­†
        const places = list.filter(p => p.tags && p.tags.name).slice(0, 15);
        
        if(places.length === 0) {
            div.innerHTML = '<p style="text-align:center; padding:20px; opacity:0.5">é™„è¿‘æ²’æœ‰æ­¤é¡åœ°é»</p>';
            return;
        }

        places.forEach(p => {
            const name = p.tags.name;
            // Google æœå°‹é€£çµ
            const searchUrl = `https://www.google.com/search?q=${encodeURIComponent(name)}`;
            // å°èˆªé€£çµ
            const navUrl = `https://www.google.com/maps/dir/?api=1&destination=${p.lat},${p.lon}`;

            const card = document.createElement('div');
            card.className = 'place-card';
            card.innerHTML = `
                <div class="place-name">${name}</div>
                <div class="place-info">ç¶“ç·¯åº¦: ${p.lat.toFixed(3)}, ${p.lon.toFixed(3)}</div>
                <div class="btn-group">
                    <a href="${navUrl}" target="_blank" class="action-btn btn-nav">ğŸš€ å°èˆª</a>
                    <a href="${searchUrl}" target="_blank" class="action-btn btn-review">ğŸ” æŸ¥ Google è©•åƒ¹</a>
                </div>
            `;
            div.appendChild(card);
        });
    }
</script>
</body>
</html>
