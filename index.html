<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Travel OS Dark</title>
    <style>
        :root {
            /* ğŸ¨ æ·±è‰²æ¨¡å¼é…è‰² */
            --bg-color: #0B1120;       
            --card-bg: #1E293B;        
            --text-main: #F8FAFC;      
            --text-sub: #94A3B8;       
            --accent-green: #10B981;   
            --accent-blue: #3B82F6;    
            --review-bg: #0F172A;      
            --nav-btn-bg: #334155;     
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--bg-color); 
            margin: 0; padding: 0; 
            color: var(--text-main); 
            -webkit-tap-highlight-color: transparent; 
        }
        
        /* æ¨™é¡Œå€ */
        header { 
            background: rgba(11, 17, 32, 0.95); 
            backdrop-filter: blur(10px); 
            position: sticky; top: 0; z-index: 100; 
            padding: 16px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex; justify-content: space-between; align-items: center;
        }
        .brand { font-size: 20px; font-weight: 800; letter-spacing: 0.5px; }
        .brand span { font-size: 10px; display: block; color: var(--text-sub); font-weight: 400; margin-top: 2px; }
        .status-dot { width: 8px; height: 8px; background-color: var(--accent-green); border-radius: 50%; box-shadow: 0 0 10px var(--accent-green); }

        /* ç¬¬ä¸€å±¤ï¼šå¤§åˆ†é¡ Tab */
        .main-tabs { display: flex; padding: 15px 15px 5px; gap: 10px; overflow-x: auto; scrollbar-width: none; }
        .tab-btn { 
            flex: 1; border: 1px solid rgba(255,255,255,0.1); 
            background: rgba(255,255,255,0.05); color: var(--text-sub); 
            padding: 12px 0; border-radius: 24px; font-size: 14px; font-weight: 600; 
            cursor: pointer; transition: all 0.3s; white-space: nowrap; padding-left: 15px; padding-right: 15px;
        }
        .tab-btn.active { background: var(--text-main); color: var(--bg-color); }

        /* ç¬¬äºŒå±¤ï¼šç´°é …è† å›Š */
        .sub-nav-container { padding: 10px 15px 20px 15px; }
        .sub-scroll-wrapper { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .sub-scroll-wrapper::-webkit-scrollbar { display: none; }

        .chip-btn { 
            border: 1px solid #334155; background: transparent; color: var(--text-sub);
            padding: 8px 16px; font-size: 13px; font-weight: 500; border-radius: 20px; 
            white-space: nowrap; cursor: pointer; transition: all 0.2s; flex-shrink: 0;
            display: flex; align-items: center; gap: 6px;
        }
        .chip-btn.active { background: var(--accent-blue); color: white; border-color: var(--accent-blue); box-shadow: 0 0 15px rgba(59, 130, 246, 0.4); }

        /* åœ°åœ–å€ */
        .map-container { padding: 0 15px; margin-bottom: 20px; opacity: 0; height: 0; transition: all 0.5s; overflow: hidden; }
        .map-container.show { opacity: 1; height: 30vh; }
        #map { width: 100%; height: 100%; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); filter: grayscale(20%) invert(0%); }

        /* çµæœåˆ—è¡¨ */
        .results-container { padding: 0 15px 80px 15px; max-width: 600px; margin: 0 auto; }
        
        /* å¡ç‰‡è¨­è¨ˆ */
        .place-card { 
            background: var(--card-bg); 
            border-radius: 24px; 
            padding: 20px; 
            margin-bottom: 16px; 
            border: 1px solid rgba(255,255,255,0.05);
            animation: slideUp 0.4s ease forwards;
        }

        .card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .place-name { font-size: 18px; font-weight: 700; color: #fff; line-height: 1.3; flex: 1; margin-right: 10px; }
        
        .rating-badge { 
            background: rgba(16, 185, 129, 0.2); 
            color: var(--accent-green); 
            padding: 4px 10px; border-radius: 8px; 
            font-size: 13px; font-weight: 800; 
            display: flex; align-items: center; gap: 4px; flex-shrink: 0;
        }

        .status-row { font-size: 13px; color: var(--text-sub); margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        .dot-open { width: 6px; height: 6px; background: var(--accent-green); border-radius: 50%; }
        .dot-close { width: 6px; height: 6px; background: #EF4444; border-radius: 50%; }

        /* è©•è«–å€å¡Š */
        .review-box {
            background: var(--review-bg);
            border-radius: 16px;
            padding: 12px 16px;
            position: relative;
            margin-bottom: 16px;
            border-left: 3px solid var(--accent-green);
        }
        .review-label { font-size: 11px; color: var(--accent-green); font-weight: 700; margin-bottom: 4px; display: flex; align-items: center; gap: 4px; }
        .review-text { font-size: 13px; color: #CBD5E1; line-height: 1.5; font-style: italic; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }

        /* å°èˆªæŒ‰éˆ• */
        .nav-btn {
            width: 100%;
            background: var(--nav-btn-bg);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 14px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            display: flex; justify-content: center; align-items: center; gap: 6px;
            transition: background 0.2s;
        }
        .nav-btn:active { background: #475569; transform: scale(0.98); }

        .empty-state { text-align: center; margin-top: 60px; color: var(--text-sub); font-size: 14px; }
        
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<header>
    <div class="brand">
        Travel OS
        <span>PROXIMITY & REVIEW SYSTEM</span>
    </div>
    <div class="status-dot"></div>
</header>

<div class="main-tabs">
    <button class="tab-btn active" onclick="selectCategory('fun')">ç©æ¨‚</button>
    <button class="tab-btn" onclick="selectCategory('food')">ç¾é£Ÿ</button>
    <button class="tab-btn" onclick="selectCategory('medical')">å¥åº·</button>
    <button class="tab-btn" onclick="selectCategory('life')">ä¾¿åˆ©</button>
</div>

<div class="sub-nav-container">
    <div class="sub-scroll-wrapper" id="sub-nav"></div>
</div>

<div class="map-container" id="map-wrapper">
    <div id="map"></div>
</div>

<div class="results-container" id="results">
    <div class="empty-state">
        <p>SYSTEM READY<br>Select a category to scan nearby locations</p>
    </div>
</div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDyaGpwDguvqVwYGPN1CsVbuddU18dtHEs&loading=async&libraries=places,maps"></script>

<script>
    let map;
    let userLocation = null;
    let currentMarkers = [];

    // ğŸŒŸ è¨­å®šæª”ï¼šå·²æ ¹æ“šéœ€æ±‚ä¿®æ”¹
    const CATEGORIES = {
        'fun': [
            { name: "é™„è¿‘å…¬åœ’", query: "å…¬åœ’", icon: "ğŸ›" },
            { name: "è§€å…‰æ™¯é»", query: "è§€å…‰æ™¯é»", icon: "ğŸ“¸" },
            { name: "ç™¾è²¨è³¼ç‰©", query: "ç™¾è²¨å…¬å¸", icon: "ğŸ›ï¸" },
            { name: "å®¤å…§éŠæ¨‚", query: "å®¤å…§éŠæ¨‚åœ’", icon: "ğŸ§©" }
        ],
        'food': [
            // ä¿®æ­£ï¼šè¦ªå­èˆ‡å¯µç‰©åˆä½µï¼Œæœå°‹é—œéµå­—åŒ…å«å…©ç¨®
            { name: "è¦ªå­å¯µç‰©", query: "è¦ªå­é¤å»³ å¯µç‰©å‹å–„é¤å»³", icon: "ğŸ¶" }, 
            { name: "æ‰‹æ–é£²æ–™", query: "é£²æ–™åº—", icon: "ğŸ¥¤" },
            { name: "å’–å•¡ç”œé»", query: "å’–å•¡å»³ ç”œé»", icon: "â˜•" },
            { name: "åœ¨åœ°å°åƒ", query: "å°åƒ éºµåº—", icon: "ğŸœ" },
            { name: "ç«é‹ç‡’è‚‰", query: "ç«é‹ ç‡’è‚‰", icon: "ğŸ”¥" },
            { name: "æ—©åˆé¤", query: "æ—©åˆé¤", icon: "ğŸ³" }
        ],
        'medical': [
            // ä¿®æ­£ï¼šæ’åºèˆ‡é—œéµå­—ï¼Œæ€¥è¨ºåªæ‰¾å¤§é†«é™¢
            { name: "æ€¥è¨ºé†«é™¢", query: "é†«å­¸ä¸­å¿ƒ ç¶œåˆé†«é™¢ æ€¥è¨º", icon: "ğŸ¥" },
            { name: "å°å…’ç§‘", query: "å°å…’ç§‘è¨ºæ‰€", icon: "ğŸ‘¶" },
            { name: "è€³é¼»å–‰ç§‘", query: "è€³é¼»å–‰ç§‘è¨ºæ‰€", icon: "ğŸ‘‚" },
            // æ–°å¢ï¼šä¸€èˆ¬è¨ºæ‰€ (å®¶é†«ç§‘/å…§ç§‘)
            { name: "ä¸€èˆ¬è¨ºæ‰€", query: "è¨ºæ‰€ å®¶é†«ç§‘ å…§ç§‘", icon: "ğŸ©º" }, 
            { name: "è—¥å±€", query: "è—¥å±€", icon: "ğŸ’Š" }
        ],
        'life': [
            { name: "ä¾¿åˆ©è¶…å•†", query: "ä¾¿åˆ©å•†åº—", icon: "ğŸª" },
            { name: "åœè»Šå ´", query: "åœè»Šå ´", icon: "ğŸ…¿ï¸" },
            { name: "åŠ æ²¹ç«™", query: "åŠ æ²¹ç«™", icon: "â›½" },
            { name: "å»æ‰€", query: "å…¬å»", icon: "ğŸš¾" }
        ]
    };

    window.onload = () => { renderSubNav('fun'); };

    function selectCategory(cat) {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        renderSubNav(cat);
    }

    function renderSubNav(cat) {
        const container = document.getElementById('sub-nav');
        container.innerHTML = '';
        CATEGORIES[cat].forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'chip-btn';
            btn.innerHTML = `${opt.icon} ${opt.name}`;
            btn.onclick = () => startSearch(opt.query, btn);
            container.appendChild(btn);
        });
    }

    // æ ¸å¿ƒæœå°‹åŠŸèƒ½
    function startSearch(query, btnElement) {
        document.querySelectorAll('.chip-btn').forEach(b => b.classList.remove('active'));
        btnElement.classList.add('active');

        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = '<div class="empty-state"><p>SCANNING AREA...</p></div>';
        
        clearMarkers();

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    userLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
                    document.getElementById('map-wrapper').classList.add('show');
                    await initMap(userLocation.lat, userLocation.lng);
                    await performSearch(userLocation, query);
                },
                (error) => { resultsDiv.innerHTML = '<div class="empty-state">LOCATION ACCESS DENIED</div>'; }
            );
        }
    }

    async function initMap(lat, lng) {
        const { Map } = await google.maps.importLibrary("maps");
        const center = { lat: lat, lng: lng };
        if (!map) {
            map = new Map(document.getElementById("map"), {
                center: center, zoom: 14, mapId: "DEMO_MAP_ID", disableDefaultUI: true,
                styles: [ { elementType: "geometry", stylers: [{ color: "#242f3e" }] }, { elementType: "labels.text.stroke", stylers: [{ color: "#242f3e" }] }, { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] } ]
            });
        } else {
            map.setCenter(center);
        }
        new google.maps.Marker({
            position: center, map: map,
            icon: { path: google.maps.SymbolPath.CIRCLE, scale: 7, fillColor: "#3B82F6", fillOpacity: 1, strokeWeight: 2, strokeColor: "white" }
        });
    }

    function clearMarkers() {
        currentMarkers.forEach(m => m.setMap(null));
        currentMarkers = [];
    }

    async function performSearch(location, query) {
        const { Place } = await google.maps.importLibrary("places");
        const resultsDiv = document.getElementById('results');

        try {
            const request = {
                textQuery: query,
                fields: ['displayName', 'location', 'businessStatus', 'rating', 'userRatingCount', 'formattedAddress', 'id', 'reviews', 'types'],
                locationBias: { center: location, radius: 1000 },
                maxResultCount: 20, // å¢åŠ æ•¸é‡ä»¥å…éæ¿¾å¾Œå¤ªå°‘
                language: 'zh-TW',
            };

            const { places } = await Place.searchByText(request);

            if (places && places.length > 0) {
                // ğŸ›‘ é—œéµéæ¿¾é‚è¼¯ï¼šç§»é™¤ã€Œå‹•ç‰©/ç¸é†«ã€ç›¸é—œçµæœ
                // é™¤éæœå°‹é—œéµå­—æœ¬èº«å°±åŒ…å« "å‹•ç‰©" æˆ– "å¯µç‰©"
                const filteredPlaces = places.filter(p => {
                    const isSearchingForPets = query.includes('å¯µç‰©') || query.includes('å‹•ç‰©');
                    
                    // å¦‚æœä¸æ˜¯åœ¨æ‰¾å¯µç‰©ï¼Œä½†é¡åˆ¥æˆ–åç¨±åŒ…å«ç¸é†«ï¼Œå°±éæ¿¾æ‰
                    if (!isSearchingForPets) {
                        const isVetType = p.types && (p.types.includes('veterinary_care') || p.types.includes('animal_hospital'));
                        const isVetName = p.displayName && (p.displayName.includes('å‹•ç‰©é†«é™¢') || p.displayName.includes('ç¸é†«'));
                        if (isVetType || isVetName) return false;
                    }
                    return true;
                });

                resultsDiv.innerHTML = `<div style="text-align:center; font-size:12px; color:#64748B; margin:10px 0;">SCAN COMPLETE: ${filteredPlaces.length} LOCATIONS FOUND</div>`;
                
                filteredPlaces.forEach((place, index) => {
                    createPlaceCard(place, index);
                });
            } else {
                resultsDiv.innerHTML = '<div class="empty-state">NO LOCATIONS FOUND</div>';
            }
        } catch (e) {
            console.error(e);
            resultsDiv.innerHTML = '<div class="empty-state">API ERROR (CHECK CONSOLE)</div>';
        }
    }

    function createPlaceCard(place, index) {
        const resultsDiv = document.getElementById('results');
        
        const name = place.displayName || "æœªçŸ¥åœ°é»";
        const rating = place.rating ? place.rating.toFixed(1) : "N/A";
        const count = place.userRatingCount ? `(${place.userRatingCount})` : "";
        const address = place.formattedAddress ? place.formattedAddress.replace('å°ç£å°ä¸­å¸‚', '').replace(/^[0-9]+/, '') : "åœ°å€æœªæä¾›";
        
        const isOpen = place.businessStatus === 'OPERATIONAL';
        const statusHtml = isOpen 
            ? `<span class="dot-open"></span> ç‡Ÿæ¥­ä¸­` 
            : `<span class="dot-close"></span> ä¼‘æ¯ä¸­`;

        let reviewHtml = '';
        if (place.reviews && place.reviews.length > 0) {
            const review = place.reviews[0]; 
            const text = review.text.length > 65 ? review.text.substring(0, 65) + "..." : review.text;
            reviewHtml = `<div class="review-box"><div class="review-label">ğŸ’¬ æœ€æ–°è©•åƒ¹</div><div class="review-text">"${text}"</div></div>`;
        } else {
            reviewHtml = `<div class="review-box" style="opacity:0.5"><div class="review-label">ğŸ’¬ æš«ç„¡è©•åƒ¹</div></div>`;
        }

        const card = document.createElement('div');
        card.className = 'place-card';
        card.style.animationDelay = `${index * 0.1}s`;
        
        card.innerHTML = `
            <div class="card-top">
                <div class="place-name">${name}</div>
                <div class="rating-badge">â˜… ${rating} <span style="font-weight:400; font-size:11px; margin-left:2px;">${count}</span></div>
            </div>
            <div class="status-row">${statusHtml} â€¢ ${address}</div>
            ${reviewHtml}
            <button class="nav-btn" onclick="openGoogleMaps('${place.id}', '${name}')">NAVIGATE â”</button>
        `;

        resultsDiv.appendChild(card);

        const marker = new google.maps.Marker({
            position: place.location, map: map,
            label: { text: (index+1).toString(), color: "white", fontSize: "12px" }
        });
        currentMarkers.push(marker);
    }

    function openGoogleMaps(placeId, name) {
        const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(name)}&query_place_id=${placeId}`;
        window.open(url, '_blank');
    }
</script>

</body>
</html>
