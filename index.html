<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¦ªå­æ™ºæ…§å°éŠ (æ™¯é»+ç¾é£Ÿç‰ˆ)</title>
    <style>
        body { font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; background-color: #f4f7f6; margin: 0; padding: 0; color: #333; }
        header { background-color: #00bcd4; color: white; padding: 15px; text-align: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        header h1 { margin: 0; font-size: 1.2rem; }
        header p { margin: 5px 0 0; font-size: 0.8rem; opacity: 0.9; }
        
        /* æ§åˆ¶å€å¡Šï¼šæ”¹æˆå½ˆæ€§ä½ˆå±€ï¼Œæ”¾å…©é¡†æŒ‰éˆ• */
        .controls { padding: 15px; text-align: center; background: white; border-bottom: 1px solid #eee; }
        .btn-group { display: flex; gap: 10px; justify-content: center; margin-bottom: 10px; }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        button { border: none; padding: 12px 20px; font-size: 0.95rem; border-radius: 50px; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1); color: white; flex: 1; max-width: 200px; transition: transform 0.1s; }
        button:active { transform: scale(0.95); }
        button:disabled { background-color: #ccc !important; }
        
        /* æ™¯é»æŒ‰éˆ• (æ©˜è‰²) */
        .btn-fun { background-color: #ff9800; }
        /* ç¾é£ŸæŒ‰éˆ• (ç´…è‰²) */
        .btn-food { background-color: #ff5252; }

        #status { margin-top: 5px; font-size: 0.9rem; color: #666; min-height: 1.2em; }
        #map { width: 100%; height: 40vh; background-color: #e0e0e0; } /* åœ°åœ–åŠ å¤§ä¸€é» */
        
        .results-container { padding: 15px; max-width: 800px; margin: 0 auto; padding-bottom: 50px; }
        .place-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .place-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .place-name { font-size: 1.1rem; font-weight: bold; color: #2c3e50; margin: 0; }
        .place-rating { background: #fff3cd; color: #856404; padding: 2px 6px; border-radius: 4px; font-size: 0.85rem; font-weight: bold; white-space: nowrap; }
        .place-info { font-size: 0.9rem; color: #555; margin: 5px 0; }
        
        /* çˆ¸åª½ç­†è¨˜æ¨£å¼ */
        .parent-tips { background-color: #e3f2fd; border-left: 4px solid #2196f3; padding: 10px; margin-top: 8px; border-radius: 4px; font-size: 0.85rem; }
        .food-tips { background-color: #ffebee; border-left: 4px solid #ff5252; } /* ç¾é£Ÿå°ˆç”¨ç´…è‰²ç­†è¨˜ */
        
        .tags { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 8px; }
        .tag { background: #f0f0f0; color: #666; font-size: 0.75rem; padding: 3px 8px; border-radius: 10px; }
        .open-now { color: #28a745; font-weight: bold; }
        .closed-now { color: #dc3545; font-weight: bold; }
    </style>
</head>
<body>

<header>
    <h1>ğŸŒ çˆ¸åª½çš„æ—…éŠç¥éšŠå‹</h1>
    <p>æ‰¾å¥½ç©ãƒ»æ‰¾å¥½åƒãƒ»ä¸€éµæå®š</p>
</header>

<div class="controls">
    <div class="btn-group">
        <button class="btn-fun" id="btn-fun" onclick="startExplore('fun')">ğŸ¡ æ‰¾æ™¯é»</button>
        <button class="btn-food" id="btn-food" onclick="startExplore('food')">ğŸ½ï¸ æ‰¾ç¾é£Ÿ</button>
    </div>
    <div id="status">æº–å‚™å°±ç·’</div>
</div>

<div id="map"></div>

<div class="results-container" id="results">
    <p style="text-align:center; color:#999; margin-top:30px;">è«‹é¸æ“‡ä¸Šæ–¹åŠŸèƒ½é–‹å§‹æ¢ç´¢...</p>
</div>

<script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&loading=async&libraries=places,maps"></script>

<script>
    let map;
    let userLocation = null;
    let currentMarkers = []; // ç´€éŒ„åœ°åœ–ä¸Šçš„æ¨™è¨˜ï¼Œæ–¹ä¾¿åˆ‡æ›æ™‚æ¸…é™¤

    // åˆå§‹åŒ–åœ°åœ–
    async function initMap(lat, lng) {
        const { Map } = await google.maps.importLibrary("maps");
        const center = { lat: lat, lng: lng };
        
        // å¦‚æœåœ°åœ–é‚„æ²’å»ºç«‹ï¼Œæ‰å»ºç«‹æ–°çš„ï¼Œä¸ç„¶å°±åªè¦ç§»å‹•ä¸­å¿ƒé»å°±å¥½
        if (!map) {
            map = new Map(document.getElementById("map"), {
                center: center,
                zoom: 15,
                mapId: "DEMO_MAP_ID",
                disableDefaultUI: true,
                gestureHandling: "greedy" // è®“æ‰‹æŒ‡æ»‘å‹•æ›´é †æš¢
            });
        } else {
            map.setCenter(center);
            map.setZoom(15);
        }

        // æ¨™è¨˜æˆ‘çš„ä½ç½®
        new google.maps.Marker({
            position: center,
            map: map,
            title: "ä½ çš„ä½ç½®",
            icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 8,
                fillColor: "#4285F4",
                fillOpacity: 1,
                strokeWeight: 2,
                strokeColor: "white",
            },
            zIndex: 999 // æ°¸é åœ¨æœ€ä¸Šé¢
        });
    }

    // æ¸…é™¤èˆŠæ¨™è¨˜
    function clearMarkers() {
        currentMarkers.forEach(marker => marker.setMap(null));
        currentMarkers = [];
    }

    // æŒ‰éˆ•è§¸ç™¼ (mode = 'fun' æˆ– 'food')
    function startExplore(mode) {
        const statusDiv = document.getElementById('status');
        const btnFun = document.getElementById('btn-fun');
        const btnFood = document.getElementById('btn-food');
        
        // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
        btnFun.disabled = true;
        btnFood.disabled = true;
        statusDiv.innerHTML = "ğŸ“¡ å®šä½ä¸­...";

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                    };
                    
                    const modeText = mode === 'fun' ? "å¥½ç©æ™¯é»" : "ç¾å‘³é¤å»³";
                    statusDiv.innerHTML = `âœ… å®šä½æˆåŠŸï¼æœå°‹é™„è¿‘${modeText}...`;
                    
                    await initMap(userLocation.lat, userLocation.lng);
                    await searchNearby(userLocation, mode);
                    
                    btnFun.disabled = false;
                    btnFood.disabled = false;
                },
                (error) => {
                    statusDiv.innerHTML = "âŒ å®šä½å¤±æ•—ï¼Œè«‹ç¢ºèª GPSã€‚";
                    btnFun.disabled = false;
                    btnFood.disabled = false;
                }
            );
        } else {
            statusDiv.innerHTML = "âŒ ç€è¦½å™¨ä¸æ”¯æ´å®šä½ã€‚";
        }
    }

    // ğŸŒŸ æ ¸å¿ƒæœå°‹åŠŸèƒ½
    async function searchNearby(location, mode) {
        const statusDiv = document.getElementById('status');
        const resultsDiv = document.getElementById('results');
        
        try {
            const { Place, SearchNearbyRankPreference } = await google.maps.importLibrary("places");

            // æ ¹æ“šæ¨¡å¼è¨­å®šè¦æ‰¾çš„é¡å‹
            let targetTypes = [];
            if (mode === 'fun') {
                targetTypes = ['tourist_attraction', 'park', 'museum', 'shopping_mall', 'zoo', 'aquarium', 'amusement_park'];
            } else {
                targetTypes = ['restaurant', 'cafe', 'bakery', 'ice_cream_shop', 'meal_takeaway'];
            }

            const request = {
                fields: ['displayName', 'location', 'businessStatus', 'rating', 'types', 'formattedAddress', 'userRatingCount'],
                locationRestriction: {
                    center: location,
                    radius: 1500, // 1.5 å…¬é‡Œ
                },
                includedPrimaryTypes: targetTypes,
                maxResultCount: 15,
                rankPreference: SearchNearbyRankPreference.POPULARITY,
                language: 'zh-TW',
            };

            const { places } = await Place.searchNearby(request);

            // æ¸…ç©ºèˆŠçµæœ
            resultsDiv.innerHTML = "";
            clearMarkers();

            if (places.length > 0) {
                statusDiv.innerHTML = `ğŸ‰ æ‰¾åˆ° ${places.length} å€‹æ¨è–¦åœ°é»ï¼`;
                displayResults(places, mode);
            } else {
                statusDiv.innerHTML = "âš ï¸ é™„è¿‘ 1.5 å…¬é‡Œå…§æ²’æœ‰æ‰¾åˆ°ç›¸é—œåœ°é»ã€‚";
                resultsDiv.innerHTML = "<p style='text-align:center;'>é™„è¿‘æœ‰é»è’æ¶¼ï¼Œè©¦è©¦çœ‹åˆ¥çš„åœ°æ–¹ï¼Ÿ</p>";
            }

        } catch (error) {
            console.error(error);
            statusDiv.innerHTML = "âŒ æœå°‹å‡ºéŒ¯ï¼Œè«‹çœ‹ Consoleã€‚";
        }
    }

    // é¡¯ç¤ºçµæœ
    function displayResults(places, mode) {
        const resultsDiv = document.getElementById('results');

        places.forEach(place => {
            const name = place.displayName;
            const rating = place.rating;
            const address = place.formattedAddress;
            const types = place.types || [];
            
            let openStatus = "";
            if (place.businessStatus === 'OPERATIONAL') {
                openStatus = "<span class='open-now'>ğŸŸ¢ ç‡Ÿæ¥­ä¸­</span>";
            } else {
                openStatus = "<span class='closed-now'>ğŸ”´ ä¼‘æ¯/é—œé–‰</span>";
            }

            // å–å¾—å»ºè­°
            const advice = analyzeForParents(types, rating, mode);
            // æ ¹æ“šæ¨¡å¼æ›é¡è‰²
            const tipClass = mode === 'food' ? 'parent-tips food-tips' : 'parent-tips';
            const icon = mode === 'food' ? 'ğŸ´' : 'ğŸ‘¶';

            const card = document.createElement('div');
            card.className = 'place-card';
            card.innerHTML = `
                <div class="place-header">
                    <h3 class="place-name">${name}</h3>
                    ${rating ? `<div class="place-rating">â˜… ${rating} <span style="font-weight:normal;color:#999">(${place.userRatingCount})</span></div>` : ''}
                </div>
                <div class="place-info">
                    ${openStatus} <br> ğŸ“ ${address}
                </div>
                <div class="${tipClass}">
                    <strong>${icon} çˆ¸åª½ç­†è¨˜ï¼š</strong> ${advice}
                </div>
                <div class="tags">
                    ${types.slice(0, 3).map(type => `<span class="tag">${formatType(type)}</span>`).join('')}
                </div>
            `;
            
            card.onclick = () => {
                window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(name)}&query_place_id=${place.id}`, '_blank');
            };

            resultsDiv.appendChild(card);
            
            // åœ°åœ–æ¨™è¨˜
            const marker = new google.maps.Marker({
                position: place.location,
                map: map,
                title: name,
                // ç¾é£Ÿæ¨¡å¼ç”¨ç´…è‰²æ¨™è¨˜ï¼Œæ™¯é»ç”¨é è¨­ç´…è‰²
                // é€™è£¡å¯ä»¥é€²éšè‡ªè¨‚åœ–ç¤ºï¼Œå…ˆç”¨é è¨­çš„æ¯”è¼ƒç©©
            });
            currentMarkers.push(marker);
        });
    }

    // ğŸ’¡ å‡ç´šç‰ˆ AI å°éŠï¼šåŠ å…¥é¤å»³é‚è¼¯
    function analyzeForParents(types, rating, mode) {
        let advice = "";

        if (mode === 'food') {
            // --- ç¾é£Ÿæ¨¡å¼å»ºè­° ---
            if (types.includes('cafe') || types.includes('coffee_shop')) {
                advice = "çˆ¸åª½å……é›»ç«™ï¼é©åˆé»æ¯å’–å•¡ä¼‘æ¯ï¼Œç•™æ„æœ‰ç„¡å…’ç«¥ç”œé»ã€‚";
            } else if (types.includes('ice_cream_shop') || types.includes('bakery')) {
                advice = "ğŸ¦ **å®‰æ’«ç¥åº—ï¼** å°å­©é¬§è„¾æ°£æ™‚å¸¶ä¾†é€™è£¡å°±å°äº†ã€‚";
            } else if (types.includes('meal_takeaway')) {
                advice = "å¤–å¸¶æ–¹ä¾¿ï¼Œè‹¥å°å­©å¤ªç´¯å¯ä»¥åœ¨è»Šä¸Šæˆ–é£¯åº—åƒã€‚";
            } else if (rating > 4.5) {
                advice = "é«˜äººæ°£é¤å»³ï¼Œå»ºè­°å…ˆçœ‹æœ‰æ²’æœ‰å…’ç«¥æ¤…æˆ–æ˜¯å¦éœ€æ’éšŠã€‚";
            } else {
                advice = "å»ºè­°æŸ¥è©¢æ˜¯å¦æœ‰å…’ç«¥é¤å…·æˆ–ä¸è¾£çš„é¤é»ã€‚";
            }
        } else {
            // --- æ™¯é»æ¨¡å¼å»ºè­° ---
            if (types.includes('park') || types.includes('amusement_park')) {
                advice = "ğŸ”‹ **æ”¾é›»é¦–é¸ï¼** æˆ¶å¤–ç©ºé–“å¤§ï¼Œè¨˜å¾—é˜²èšŠé˜²æ›¬ã€‚";
            } else if (types.includes('museum') || types.includes('art_gallery')) {
                advice = "ğŸ¤« **å®¤å…§è¡Œç¨‹**ï¼Œé›¨å¤©å‚™æ¡ˆï¼Œç•™æ„æ˜¯å¦å¯æ¨æ¨è»Šã€‚";
            } else if (types.includes('shopping_mall')) {
                advice = "ğŸš— **åœè»Šè£œçµ¦æ–¹ä¾¿**ï¼Œé€šå¸¸æœ‰å“ºä¹³å®¤èˆ‡å†·æ°£ã€‚";
            } else if (rating > 4.5) {
                advice = "ğŸŒŸ **é«˜åˆ†å¥½è©•**ï¼Œäººæ½®å¯èƒ½è¼ƒå¤šï¼Œæ³¨æ„å°å­©å®‰å…¨ã€‚";
            } else {
                advice = "ç†±é–€åœ°é»ï¼Œå»ºè­°é»æ“ŠæŸ¥çœ‹è©³ç´°è©•è«–èˆ‡ç…§ç‰‡ã€‚";
            }
        }
        return advice;
    }

    function formatType(type) {
        const dict = { 
            'tourist_attraction': 'æ™¯é»', 'park': 'å…¬åœ’', 'museum': 'åšç‰©é¤¨', 'shopping_mall': 'å•†å ´', 
            'restaurant': 'é¤å»³', 'cafe': 'å’–å•¡å»³', 'bakery': 'éºµåŒ…åº—', 'ice_cream_shop': 'å†°æ·‡æ·‹', 
            'meal_takeaway': 'å¤–å¸¶ç¾é£Ÿ', 'store': 'å•†åº—', 'food': 'é£Ÿç‰©'
        };
        return dict[type] || type;
    }
</script>

</body>
</html>
