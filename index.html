<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Travel OS Pro - Neural</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #000000;
            --glass-panel: rgba(30, 30, 35, 0.75);
            --glass-border: rgba(255, 255, 255, 0.15);
            --neon-accent: #0A84FF;
            --neon-warn: #FF453A;
            --neon-success: #32D74B;
            --text-primary: #FFFFFF;
            --text-secondary: #9898A0;
            --card-radius: 24px;
        }

        body { 
            font-family: 'Inter', -apple-system, sans-serif; 
            background-color: var(--bg-dark); 
            background-image: 
                radial-gradient(circle at 0% 0%, #0f1c4d 0%, transparent 60%),
                radial-gradient(circle at 100% 100%, #4a0e0e 0%, transparent 60%);
            background-attachment: fixed;
            margin: 0; padding: 0; 
            color: var(--text-primary); 
            -webkit-tap-highlight-color: transparent; 
            padding-bottom: 100px;
        }
        
        /* ğŸŒ€ Header */
        header { 
            background: rgba(20, 20, 20, 0.6); 
            backdrop-filter: blur(25px) saturate(180%);
            -webkit-backdrop-filter: blur(25px);
            margin: 16px; padding: 16px 24px; 
            border-radius: 40px; border: 1px solid var(--glass-border);
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            position: sticky; top: 16px; z-index: 100;
        }
        header h1 { margin: 0; font-size: 20px; font-weight: 900; letter-spacing: 0.5px; background: linear-gradient(90deg, #fff, #8E8E93); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        header p { margin: 2px 0 0; font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; }
        .header-dot { width: 8px; height: 8px; background: var(--neon-success); border-radius: 50%; box-shadow: 0 0 10px var(--neon-success); }
        
        /* ğŸ”˜ Tabs */
        .main-tabs { 
            display: flex; margin: 10px 16px; 
            background: rgba(40, 40, 45, 0.5); 
            padding: 6px; border-radius: 32px; 
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(10px);
        }
        .tab-btn { 
            flex: 1; border: none; background: transparent; color: var(--text-secondary); 
            padding: 12px 0; border-radius: 26px; font-size: 13px; font-weight: 600; 
            cursor: pointer; transition: all 0.4s; position: relative;
        }
        .tab-btn.active { background: rgba(60, 60, 65, 0.8); color: #fff; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.1); }
        
        /* ğŸ’Š Chips */
        .sub-nav-container { margin: 0; overflow: hidden; padding: 10px 0; }
        .sub-scroll-wrapper { display: flex; gap: 12px; overflow-x: auto; padding: 0 20px 10px 20px; scrollbar-width: none; }
        .sub-scroll-wrapper::-webkit-scrollbar { display: none; }

        .chip-btn { 
            border: 1px solid var(--glass-border); background: rgba(30,30,35, 0.4); color: #fff;
            padding: 10px 20px; font-size: 13px; font-weight: 500; border-radius: 100px; 
            white-space: nowrap; cursor: pointer; transition: all 0.3s ease; backdrop-filter: blur(5px);
        }
        .chip-btn.active { background: var(--neon-accent); border-color: var(--neon-accent); box-shadow: 0 0 15px rgba(10, 132, 255, 0.4); font-weight: 700; }

        /* ğŸ—ºï¸ Map */
        .map-wrapper { padding: 0 16px; margin: 10px 0 24px 0; }
        #map { width: 100%; height: 35vh; border-radius: var(--card-radius); box-shadow: 0 20px 40px rgba(0,0,0,0.4); border: 1px solid var(--glass-border); }
        
        /* ğŸƒ Cards */
        .results-container { padding: 0 16px; max-width: 600px; margin: 0 auto; }
        .place-card { 
            background: var(--glass-panel); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border); border-radius: var(--card-radius); 
            padding: 24px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
            animation: fadeInUp 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }
        
        .place-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .place-name { font-size: 19px; font-weight: 700; color: #fff; line-height: 1.3; width: 75%; }
        
        /* è©•åˆ†æ¨™ç±¤ */
        .place-rating { padding: 6px 10px; border-radius: 10px; font-size: 13px; font-weight: 800; display: flex; align-items: center; gap: 4px; }
        .rating-high { background: rgba(50, 215, 75, 0.15); color: var(--neon-success); box-shadow: 0 0 10px rgba(50, 215, 75, 0.1); }
        .rating-low { background: rgba(255, 69, 58, 0.15); color: var(--neon-warn); box-shadow: 0 0 10px rgba(255, 69, 58, 0.1); border: 1px solid rgba(255, 69, 58, 0.3); }

        .place-meta { font-size: 12px; color: var(--text-secondary); margin-bottom: 16px; display: flex; flex-wrap: wrap; align-items: center; gap: 8px; }
        .status-dot { width: 6px; height: 6px; border-radius: 50%; display: inline-block; margin-right: 4px; }
        
        /* ğŸ’¬ è©•è«–å€å¡Š */
        .review-box { 
            background: rgba(0,0,0,0.2); padding: 14px; border-radius: 16px; 
            font-size: 13px; line-height: 1.5; color: #ddd; margin-bottom: 16px;
            border-left: 3px solid;
        }
        .review-box.good { border-color: var(--neon-success); }
        .review-box.bad { border-color: var(--neon-warn); background: rgba(255, 69, 58, 0.05); }
        
        .review-title { font-weight: 700; margin-bottom: 4px; display: block; font-size: 12px; opacity: 0.9; }
        .review-text { font-style: italic; opacity: 0.8; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }

        .action-btn {
            display: block; width: 100%; text-align: center; 
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            color: #fff; padding: 12px 0; border-radius: 16px;
            font-size: 13px; font-weight: 600; text-decoration: none; transition: all 0.2s;
        }
        .action-btn:hover { background: var(--neon-accent); border-color: var(--neon-accent); }

        #status { text-align: center; margin: 10px 0; font-size: 12px; color: rgba(255,255,255,0.4); letter-spacing: 1px; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .gm-style-cc { display: none !important; }
    </style>
</head>
<body>

<header>
    <div>
        <h1>Travel OS <span style="font-weight:300; opacity:0.7">Neural</span></h1>
        <p>Proximity & Review System</p>
    </div>
    <div class="header-dot"></div>
</header>

<div class="main-tabs">
    <button class="tab-btn active" onclick="selectCategory('fun')">ç©æ¨‚</button>
    <button class="tab-btn" onclick="selectCategory('food')">ç¾é£Ÿ</button>
    <button class="tab-btn" onclick="selectCategory('medical')">å¥åº·</button>
    <button class="tab-btn" onclick="selectCategory('life')">ä¾¿åˆ©</button>
</div>

<div class="sub-nav-container">
    <div class="sub-scroll-wrapper" id="sub-nav"></div>
</div>

<div id="status">SYSTEM READY</div>

<div class="map-wrapper">
    <div id="map"></div>
</div>

<div class="results-container" id="results">
    <div style="text-align: center; margin-top: 60px; opacity: 0.5;">
        <h3 style="font-weight:300; letter-spacing:1px;">AWAITING INPUT</h3>
        <p style="font-size:12px;">Select a category to scan nearby locations</p>
    </div>
</div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyClFqb1iWGHOvEPNLtA2-lHsQT844C4sqE&loading=async&libraries=places,maps"></script>

<script>
    let map;
    let userLocation = null;
    let currentMarkers = [];
    let currentCircle = null;

    // ğŸŒŸ è¨­å®šæª”ï¼šå·²æ•´åˆæ‚¨çš„æ‰€æœ‰éœ€æ±‚
    const CATEGORIES = {
        'fun': [
            { name: "é™„è¿‘å…¬åœ’", query: "å…¬åœ’", icon: "ğŸ›" },
            // 2. æ™¯é»ç§»åˆ°ç¬¬äºŒä½
            { name: "è§€å…‰æ™¯é»", query: "è§€å…‰æ™¯é» æ‰“å¡æ™¯é»", icon: "ğŸ“¸" },
            { name: "ç™¾è²¨è³¼ç‰©", query: "ç™¾è²¨å…¬å¸ è³¼ç‰©ä¸­å¿ƒ", icon: "ğŸ›ï¸" },
            { name: "å®¤å…§éŠæ¨‚", query: "å®¤å…§éŠæ¨‚åœ’ è¦ªå­é¤¨ éŠæˆ²å ´", icon: "ğŸ§©" },
            { name: "æ›¸åº—åœ–é¤¨", query: "æ›¸åº— åœ–æ›¸é¤¨", icon: "ğŸ“š" }
        ],
        'food': [
            // 1. æ–°å¢æ‰‹æ–é£²
            { name: "æ‰‹æ–é£²æ–™", query: "æ‰‹æ–é£² é£²æ–™åº— 50åµ å¯ä¸å¯", icon: "ğŸ§‹" },
            { name: "è¦ªå­é¤å»³", query: "è¦ªå­é¤å»³", icon: "ğŸ‘¶" },
            { name: "å’–å•¡ç”œé»", query: "å’–å•¡å»³ ç”œé»", icon: "ğŸ°" },
            { name: "åœ¨åœ°å°åƒ", query: "å°åƒ éºµåº— ä¾¿ç•¶", icon: "ğŸœ" },
            { name: "ç«é‹ç‡’è‚‰", query: "ç«é‹ ç‡’è‚‰", icon: "ğŸ”¥" },
            { name: "æ—©åˆé¤", query: "æ—©åˆé¤", icon: "ğŸ¥ª" }
        ],
        'medical': [
            { name: "ä¸€èˆ¬è¨ºæ‰€", query: "è¨ºæ‰€ å®¶é†«ç§‘ å…§ç§‘", icon: "ğŸ©º" },
            // 2. æ–°å¢è€³é¼»å–‰ç§‘
            { name: "è€³é¼»å–‰ç§‘", query: "è€³é¼»å–‰ç§‘è¨ºæ‰€", icon: "ğŸ‘‚" },
            { name: "å°å…’ç§‘", query: "å°å…’ç§‘", icon: "ğŸ‘¶" },
            { name: "æ€¥è¨ºé†«é™¢", query: "é†«é™¢ æ€¥è¨º", icon: "ğŸ¥" },
            { name: "è—¥å±€", query: "è—¥å±€", icon: "ğŸ’Š" },
            // 2. æ–°å¢å¯µç‰©é†«é™¢ (æ”¾åœ¨æœ€å³é‚Š)
            { name: "å¯µç‰©é†«é™¢", query: "å‹•ç‰©é†«é™¢ ç¸é†« 24å°æ™‚å‹•ç‰©é†«é™¢", icon: "ğŸ¶" }
        ],
        'life': [
            { name: "å‹•ç‰©æ°´æ—", query: "å¯µç‰©åº— æ°´æ—é¤¨ é­šä¸­é­š", icon: "ğŸ " },
            { name: "ä¾¿åˆ©è¶…å•†", query: "ä¾¿åˆ©å•†åº— 7-11 å…¨å®¶", icon: "ğŸª" },
            { name: "åœè»Šå ´", query: "åœè»Šå ´", icon: "ğŸ…¿ï¸" },
            { name: "åŠ æ²¹ç«™", query: "åŠ æ²¹ç«™", icon: "â›½" }
        ]
    };

    let currentCategory = 'fun';
    window.onload = () => { renderSubNav('fun'); };

    function selectCategory(cat) {
        currentCategory = cat;
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.currentTarget.classList.add('active');
        renderSubNav(cat);
    }

    function renderSubNav(cat) {
        const container = document.getElementById('sub-nav');
        container.innerHTML = '';
        const options = CATEGORIES[cat];
        options.forEach((opt) => {
            const btn = document.createElement('button');
            btn.className = 'chip-btn';
            btn.innerHTML = `${opt.icon} ${opt.name}`;
            btn.onclick = () => startSearch(opt.query, btn);
            container.appendChild(btn);
        });
    }

    function startSearch(query, btnElement) {
        document.querySelectorAll('.chip-btn').forEach(b => b.classList.remove('active'));
        btnElement.classList.add('active');
        
        const statusDiv = document.getElementById('status');
        statusDiv.innerHTML = "ğŸ“¡ SCANNING...";
        document.getElementById('results').innerHTML = '<div style="text-align:center; padding:40px; color:#666;"><p>Processing...</p></div>';
        clearMarkers();

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    userLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
                    statusDiv.innerHTML = `TARGET: ${query}`;
                    await initMap(userLocation.lat, userLocation.lng);
                    // åŸ·è¡Œæœå°‹ (å«è‡ªå‹•é‡è©¦æ©Ÿåˆ¶)
                    await performSearch(userLocation, query);
                    statusDiv.innerHTML = "SCAN COMPLETE";
                },
                (error) => {
                    statusDiv.innerHTML = "GPS ERROR";
                    document.getElementById('results').innerHTML = '<div style="text-align:center; color:#FF453A;"><h3>Location Denied</h3><p>Please enable GPS permissions.</p></div>';
                }
            );
        } else { statusDiv.innerHTML = "SYSTEM ERROR"; }
    }

    async function initMap(lat, lng) {
        const { Map } = await google.maps.importLibrary("maps");
        const center = { lat: lat, lng: lng };
        const darkMapStyle = [
            { elementType: "geometry", stylers: [{ color: "#242f3e" }] },
            { elementType: "labels.text.stroke", stylers: [{ color: "#242f3e" }] },
            { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] },
            { featureType: "road", elementType: "geometry", stylers: [{ color: "#38414e" }] },
            { featureType: "road", elementType: "geometry.stroke", stylers: [{ color: "#212a37" }] },
            { featureType: "water", elementType: "geometry", stylers: [{ color: "#17263c" }] }
        ];

        if (!map) {
            map = new Map(document.getElementById("map"), {
                center: center, zoom: 15, mapId: "DEMO_MAP_ID", 
                disableDefaultUI: true, gestureHandling: "greedy", styles: darkMapStyle
            });
        } else {
            map.setCenter(center); map.setZoom(15);
        }

        if (currentCircle) currentCircle.setMap(null);
        currentCircle = new google.maps.Marker({
            position: center, map: map,
            icon: { path: google.maps.SymbolPath.CIRCLE, scale: 8, fillColor: "#0A84FF", fillOpacity: 1, strokeWeight: 4, strokeColor: "rgba(10, 132, 255, 0.3)" },
            zIndex: 999 
        });
    }

    function clearMarkers() {
        currentMarkers.forEach(marker => marker.setMap(null));
        currentMarkers = [];
    }

    // ğŸŒŸ å¼·åŒ–ç‰ˆæœå°‹å‡½æ•¸ï¼šå…·å‚™éŒ¯èª¤æ•æ‰èˆ‡è‡ªå‹•é™ç´šåŠŸèƒ½
    async function performSearch(location, query, retryMode = false) {
        const { Place } = await google.maps.importLibrary("places");
        const { SearchByTextRankPreference } = await google.maps.importLibrary("places");

        try {
            let request = {
                textQuery: query,
                fields: ['displayName', 'location', 'businessStatus', 'rating', 'formattedAddress', 'id', 'userRatingCount', 'reviews'],
                maxResultCount: 20,
                language: 'zh-TW',
                locationBias: { center: location },
                isOpenNow: false // æ‰¾æ‰€æœ‰åœ°é»ï¼Œä¸åªç‡Ÿæ¥­ä¸­
            };

            // ç¬¬ä¸€æ¬¡å˜—è©¦ï¼šåš´æ ¼çš„è·é›¢æ’åº (éœ€è¦ Places API New + Billing)
            if (!retryMode) {
                request.rankPreference = SearchByTextRankPreference.DISTANCE;
            } else {
                // å¦‚æœå¤±æ•—ï¼Œç¬¬äºŒæ¬¡å˜—è©¦ï¼šä½¿ç”¨é è¨­ç›¸é—œæ€§æ’åº (ç•¶ä½œå‚™æ¡ˆ)
                console.log("Switching to relevance search...");
                request.locationBias = { center: location, radius: 2000 };
            }

            const { places } = await Place.searchByText(request);
            
            if (places && places.length > 0) {
                displayResults(places, query);
            } else {
                document.getElementById('results').innerHTML = '<div style="text-align:center; padding:40px; opacity:0.6;"><p>No results found nearby.</p></div>';
            }
        } catch (e) {
            console.error("Search failed:", e);
            
            // ğŸ›¡ï¸ è‡ªå‹•éŒ¯èª¤è™•ç†æ©Ÿåˆ¶
            if (!retryMode) {
                // ç¬¬ä¸€æ¬¡å¤±æ•—ï¼Œè‡ªå‹•é‡è©¦ã€Œæ™®é€šæ¨¡å¼ã€
                await performSearch(location, query, true);
            } else {
                // å¦‚æœé€£æ™®é€šæ¨¡å¼éƒ½å¤±æ•—ï¼Œé¡¯ç¤ºéŒ¯èª¤åŸå› 
                let errorMsg = e.message || JSON.stringify(e);
                let friendlyMsg = "API Connection Error";
                
                if (errorMsg.includes("IsNotEnabled")) friendlyMsg = "è«‹è‡³ Google Cloud å•Ÿç”¨ Places API (New)";
                if (errorMsg.includes("Billing")) friendlyMsg = "API éœ€è¦å•Ÿç”¨å¸³å–®åŠŸèƒ½ (Billing)";
                
                document.getElementById('results').innerHTML = `
                    <div style="text-align:center; padding:30px; color:#FF453A;">
                        <h3>${friendlyMsg}</h3>
                        <p style="font-size:11px; opacity:0.7; margin-top:10px">${errorMsg}</p>
                    </div>
                `;
            }
        }
    }

    function displayResults(places, query) {
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = "";
        
        places.forEach((place, index) => {
            const name = place.displayName || "Unknown";
            const rating = place.rating || 0;
            const count = place.userRatingCount ? `(${place.userRatingCount})` : "";
            let address = place.formattedAddress || "";
            address = address.replace(/^[^å¸‚]+[å¸‚ç¸£]/, '').replace(/^\d+/, ''); 
            const isOpen = place.businessStatus === 'OPERATIONAL';
            const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(name)}&query_place_id=${place.id}`;
            
            const isLowRating = rating > 0 && rating < 4.0;
            let reviewHtml = "";
            
            // è™•ç†è©•è«–é¡¯ç¤º
            if (place.reviews && place.reviews.length > 0) {
                const reviewText = place.reviews[0].text || "ç„¡æ–‡å­—è©•è«–";
                if (isLowRating) {
                    reviewHtml = `
                        <div class="review-box bad">
                            <span class="review-title" style="color:#FF453A">âš ï¸ æ³¨æ„ï¼šè©•åˆ†åä½ (${rating})</span>
                            <span class="review-text">"${reviewText}"</span>
                        </div>`;
                } else {
                    reviewHtml = `
                        <div class="review-box good">
                            <span class="review-title" style="color:#32D74B">ğŸ’¬ æœ€æ–°è©•åƒ¹</span>
                            <span class="review-text">"${reviewText}"</span>
                        </div>`;
                }
            } else {
                 if (isLowRating) {
                    reviewHtml = `<div class="review-box bad"><span class="review-title" style="color:#FF453A">âš ï¸ è©•åˆ†ä½æ–¼ 4.0ï¼Œè«‹ç•™æ„ã€‚</span></div>`;
                }
            }

            const card = document.createElement('div');
            card.className = 'place-card';
            card.style.animationDelay = `${index * 0.05}s`;
            const ratingClass = isLowRating ? 'rating-low' : 'rating-high';
            
            card.innerHTML = `
                <div class="place-header">
                    <div class="place-name">${name}</div>
                    <div class="place-rating ${ratingClass}">
                        ${rating > 0 ? 'â˜… ' + rating : 'New'} 
                        <span style="font-weight:400; opacity:0.7; font-size:11px">${count}</span>
                    </div>
                </div>
                <div class="place-meta">
                    <div>${isOpen ? '<span class="status-dot" style="background:#32D74B"></span>ç‡Ÿæ¥­ä¸­' : '<span class="status-dot" style="background:#FF453A"></span>ä¼‘æ¯ä¸­'}</div>
                    <div>â€¢ ${address}</div>
                </div>
                ${reviewHtml}
                <a href="${mapUrl}" target="_blank" class="action-btn">NAVIGATE âœ</a>
            `;
            resultsDiv.appendChild(card);
            
            const marker = new google.maps.Marker({
                position: place.location, map: map, title: name,
                label: { text: (index + 1).toString(), color: "black", fontWeight: "bold" }
            });
            marker.addListener("click", () => card.scrollIntoView({ behavior: "smooth", block: "center" }));
            currentMarkers.push(marker);
        });
    }
</script>
</body>
</html>
