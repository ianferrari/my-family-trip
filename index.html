<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¦ªå­æ™ºæ…§å°éŠ (2025æœ€æ–°ç‰ˆ)</title>
    <style>
        body { font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; background-color: #f4f7f6; margin: 0; padding: 0; color: #333; }
        header { background-color: #00bcd4; color: white; padding: 15px; text-align: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        header h1 { margin: 0; font-size: 1.2rem; }
        header p { margin: 5px 0 0; font-size: 0.8rem; opacity: 0.9; }
        .controls { padding: 15px; text-align: center; background: white; border-bottom: 1px solid #eee; }
        button#find-btn { background-color: #ff9800; color: white; border: none; padding: 12px 25px; font-size: 1rem; border-radius: 50px; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        button#find-btn:disabled { background-color: #ccc; }
        #status { margin-top: 10px; font-size: 0.9rem; color: #666; }
        #map { width: 100%; height: 35vh; background-color: #e0e0e0; }
        .results-container { padding: 15px; max-width: 800px; margin: 0 auto; }
        .place-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .place-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .place-name { font-size: 1.1rem; font-weight: bold; color: #2c3e50; margin: 0; }
        .place-rating { background: #fff3cd; color: #856404; padding: 2px 6px; border-radius: 4px; font-size: 0.85rem; font-weight: bold; }
        .place-info { font-size: 0.9rem; color: #555; margin: 5px 0; }
        .parent-tips { background-color: #e3f2fd; border-left: 4px solid #2196f3; padding: 10px; margin-top: 8px; border-radius: 4px; font-size: 0.85rem; }
        .tags { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 8px; }
        .tag { background: #f0f0f0; color: #666; font-size: 0.75rem; padding: 3px 8px; border-radius: 10px; }
        .open-now { color: #28a745; font-weight: bold; }
        .closed-now { color: #dc3545; font-weight: bold; }
    </style>
</head>
<body>

<header>
    <h1>ğŸŒ çˆ¸åª½çš„æ—…éŠç¥éšŠå‹</h1>
    <p>2025 å…¨æ–°å‡ç´šç‰ˆ - æ‰¾æ™¯é»æ›´ç²¾æº–</p>
</header>

<div class="controls">
    <button id="find-btn" onclick="startExplore()">ğŸ“ æœå°‹é™„è¿‘ç†±é–€æ™¯é»</button>
    <div id="status">æº–å‚™å°±ç·’</div>
</div>

<div id="map"></div>

<div class="results-container" id="results">
    <p style="text-align:center; color:#999; margin-top:30px;">é»æ“Šä¸Šæ–¹æŒ‰éˆ•é–‹å§‹æ¢ç´¢...</p>
</div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyClFqb1iWGHOvEPNLtA2-lHsQT844C4sqE&loading=async&libraries=places,maps"></script>

<script>
    let map;
    let userLocation = null;

    // åˆå§‹åŒ–åœ°åœ– (æ”¹ç”¨ç¾ä»£çš„ async/await å¯«æ³•)
    async function initMap(lat, lng) {
        const { Map } = await google.maps.importLibrary("maps");
        const center = { lat: lat, lng: lng };
        
        map = new Map(document.getElementById("map"), {
            center: center,
            zoom: 15,
            mapId: "DEMO_MAP_ID", // 2025æ–°ç‰ˆå»ºè­°åŠ ä¸Š mapIdï¼Œé€™è£¡å…ˆç”¨æ¸¬è©¦ç”¨çš„
            disableDefaultUI: true
        });

        new google.maps.Marker({
            position: center,
            map: map,
            title: "ä½ çš„ä½ç½®",
             // è®“é€™é¡†æ¨™è¨˜è®Šæˆè—è‰²å°é»åœ–ç¤º
            icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 8,
                fillColor: "#4285F4",
                fillOpacity: 1,
                strokeWeight: 2,
                strokeColor: "white",
            }
        });
    }

    // æŒ‰éˆ•è§¸ç™¼
    function startExplore() {
        const statusDiv = document.getElementById('status');
        const btn = document.getElementById('find-btn');
        statusDiv.innerHTML = "ğŸ“¡ å®šä½ä¸­...";
        btn.disabled = true;

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                    };
                    statusDiv.innerHTML = "âœ… å®šä½æˆåŠŸï¼æ­£åœ¨å‘¼å«æ–°ç‰ˆ AI æœå°‹...";
                    
                    // åˆå§‹åŒ–åœ°åœ–ä¸¦ç§»å‹•éå»
                    await initMap(userLocation.lat, userLocation.lng);
                    
                    // åŸ·è¡Œæ–°ç‰ˆæœå°‹
                    await searchNearbyNew(userLocation);
                    btn.disabled = false;
                },
                (error) => {
                    statusDiv.innerHTML = "âŒ å®šä½å¤±æ•—ï¼Œè«‹ç¢ºèªæ‰‹æ©Ÿ GPS å·²é–‹å•Ÿã€‚";
                    console.error(error);
                    btn.disabled = false;
                }
            );
        } else {
            statusDiv.innerHTML = "âŒ ç€è¦½å™¨ä¸æ”¯æ´å®šä½ã€‚";
            btn.disabled = false;
        }
    }

    // ğŸŒŸ æ ¸å¿ƒï¼šä½¿ç”¨ Google Maps New Places API (2025 Version)
    async function searchNearbyNew(location) {
        const statusDiv = document.getElementById('status');
        const resultsDiv = document.getElementById('results');
        
        try {
            // åŒ¯å…¥æ–°ç‰ˆåœ°é»åº«
            const { Place, SearchNearbyRankPreference } = await google.maps.importLibrary("places");

            // è¨­å®šæœå°‹æ¢ä»¶
            const request = {
                // å¿…è¦çš„æ¬„ä½ (å¦‚æœä¸æŒ‡å®šï¼Œå¯èƒ½æœƒè¢«å¤šæ”¶è²»æˆ–å ±éŒ¯)
                fields: ['displayName', 'location', 'businessStatus', 'rating', 'types', 'formattedAddress'],
                locationRestriction: {
                    center: location,
                    radius: 1500, // 1.5 å…¬é‡Œ
                },
                // è¨­å®šè¦æ‰¾çš„é¡å‹ (åŒ…å«æ™¯é»ã€å…¬åœ’ã€åšç‰©é¤¨ã€å•†å ´)
                includedPrimaryTypes: ['tourist_attraction', 'park', 'museum', 'shopping_mall', 'zoo', 'aquarium', 'amusement_park'],
                maxResultCount: 10,
                rankPreference: SearchNearbyRankPreference.POPULARITY,
                language: 'zh-TW',
            };

            // åŸ·è¡Œæœå°‹
            const { places } = await Place.searchNearby(request);

            if (places.length > 0) {
                statusDiv.innerHTML = `ğŸ‰ æˆåŠŸæ‰¾åˆ° ${places.length} å€‹ç†±é–€åœ°é»ï¼`;
                displayNewResults(places);
            } else {
                statusDiv.innerHTML = "âš ï¸ é™„è¿‘ 1.5 å…¬é‡Œå…§æ²’æœ‰æ‰¾åˆ°ç‰¹å®šæ™¯é»ã€‚";
                resultsDiv.innerHTML = "<p style='text-align:center;'>é™„è¿‘å¥½åƒæ¯”è¼ƒè’æ¶¼ï¼Œè©¦è©¦çœ‹æ“´å¤§ç¯„åœï¼Ÿ</p>";
            }

        } catch (error) {
            console.error("æœå°‹ç™¼ç”ŸéŒ¯èª¤:", error);
            statusDiv.innerHTML = "âŒ æœå°‹å‡ºéŒ¯ï¼Œè«‹çœ‹ Console éŒ¯èª¤è¨Šæ¯ (å¯èƒ½éœ€è¦å•Ÿç”¨ Places API New)ã€‚";
        }
    }

    // é¡¯ç¤ºçµæœå¡ç‰‡
    function displayNewResults(places) {
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = "";

        places.forEach(place => {
            // æ–°ç‰ˆ API çš„è³‡æ–™çµæ§‹ç¨æœ‰ä¸åŒ
            const name = place.displayName; // é€™è£¡ç›´æ¥å–å­—ä¸²
            const rating = place.rating;
            const address = place.formattedAddress;
            const types = place.types || [];
            
            // åˆ¤æ–·ç‡Ÿæ¥­ç‹€æ…‹ (æ–°ç‰ˆ API çš„ businessStatus)
            let openStatus = "";
            if (place.businessStatus === 'OPERATIONAL') {
                openStatus = "<span class='open-now'>ğŸŸ¢ æ­£å¸¸ç‡Ÿé‹ä¸­</span>";
            } else {
                openStatus = "<span class='closed-now'>ğŸ”´ å¯èƒ½å·²é—œé–‰</span>";
            }

            // AI å°éŠåˆ†æ
            const advice = analyzeForParents(types, rating);

            const card = document.createElement('div');
            card.className = 'place-card';
            card.innerHTML = `
                <div class="place-header">
                    <h3 class="place-name">${name}</h3>
                    ${rating ? `<div class="place-rating">â˜… ${rating}</div>` : ''}
                </div>
                <div class="place-info">
                    ${openStatus} <br> ğŸ“ ${address}
                </div>
                <div class="parent-tips">
                    <strong>ğŸ‘¶ çˆ¸åª½ç­†è¨˜ï¼š</strong> ${advice}
                </div>
                <div class="tags">
                    ${types.slice(0, 3).map(type => `<span class="tag">${formatType(type)}</span>`).join('')}
                </div>
            `;
            
            // é»æ“Šå°èˆª
            card.onclick = () => {
                // ä½¿ç”¨åœ°é»åç¨±é€²è¡Œå°èˆª
                window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(name)}`, '_blank');
            };

            resultsDiv.appendChild(card);
            
            // åŠ åœ°åœ–æ¨™è¨˜
            new google.maps.Marker({
                position: place.location,
                map: map,
                title: name
            });
        });
    }

    function analyzeForParents(types, rating) {
        let advice = "ç†±é–€åœ°é»ï¼Œå»ºè­°å…ˆæŸ¥è©•è«–ã€‚";
        if (types.includes('park') || types.includes('amusement_park')) {
            advice = "ğŸ”‹ **æ”¾é›»é¦–é¸ï¼** æˆ¶å¤–ç©ºé–“å¤§ï¼Œè¨˜å¾—é˜²èšŠé˜²æ›¬ã€‚";
        } else if (types.includes('museum') || types.includes('art_gallery')) {
            advice = "ğŸ¤« **å®¤å…§è¡Œç¨‹**ï¼Œé›¨å¤©å‚™æ¡ˆï¼Œç•™æ„æ˜¯å¦å¯æ¨æ¨è»Šã€‚";
        } else if (types.includes('shopping_mall')) {
            advice = "ğŸš— **åœè»Šè£œçµ¦æ–¹ä¾¿**ï¼Œé€šå¸¸æœ‰å“ºä¹³å®¤èˆ‡å†·æ°£ã€‚";
        } else if (types.includes('zoo') || types.includes('aquarium')) {
            advice = "ğŸ¦„ **å¿…å»ï¼** å°å­©æœƒå¾ˆæ„›ï¼Œå»ºè­°é ç•™åŠå¤©æ™‚é–“ã€‚";
        } else if (rating > 4.5) {
            advice = "ğŸŒŸ **é«˜åˆ†å¥½è©•**ï¼Œäººæ½®å¯èƒ½è¼ƒå¤šï¼Œæ³¨æ„å°å­©å®‰å…¨ã€‚";
        }
        return advice;
    }

    function formatType(type) {
        const dict = { 'tourist_attraction': 'æ™¯é»', 'park': 'å…¬åœ’', 'museum': 'åšç‰©é¤¨', 'shopping_mall': 'å•†å ´', 'restaurant': 'é¤å»³', 'place_of_worship': 'å»Ÿå®‡/æ•™å ‚', 'store': 'å•†åº—' };
        return dict[type] || type;
    }
</script>

</body>
</html>
