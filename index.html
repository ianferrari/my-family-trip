<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Travel OS</title>
    <style>
        :root {
            --ios-bg: #F2F2F7;
            --ios-card: #FFFFFF;
            --ios-blue: #007AFF;
            --ios-orange: #FF9500;
            --ios-red: #FF3B30;
            --ios-green: #34C759;
            --ios-gray-text: #8E8E93;
            --glass-material: rgba(255, 255, 255, 0.85);
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.06);
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif; background-color: var(--ios-bg); margin: 0; padding: 0; color: #1C1C1E; -webkit-tap-highlight-color: transparent; }
        header { background: var(--glass-material); backdrop-filter: saturate(180%) blur(20px); -webkit-backdrop-filter: saturate(180%) blur(20px); position: sticky; top: 0; z-index: 100; border-bottom: 0.5px solid rgba(0,0,0,0.1); padding: 12px 20px; }
        header h1 { margin: 0; font-size: 28px; font-weight: 800; letter-spacing: -0.5px; }
        header p { margin: 4px 0 0; font-size: 13px; color: var(--ios-gray-text); font-weight: 500; }
        .controls-container { padding: 16px 20px; background: var(--ios-bg); }
        .btn-group { display: flex; gap: 12px; background: rgba(118, 118, 128, 0.12); padding: 4px; border-radius: 14px; }
        button { flex: 1; border: none; padding: 12px; font-size: 15px; font-weight: 600; border-radius: 10px; cursor: pointer; transition: all 0.2s; background: transparent; color: var(--ios-gray-text); }
        button.active-fun { background: var(--ios-card); color: var(--ios-orange); box-shadow: 0 3px 8px rgba(0,0,0,0.12); }
        button.active-food { background: var(--ios-card); color: var(--ios-red); box-shadow: 0 3px 8px rgba(0,0,0,0.12); }
        button:active { transform: scale(0.96); }
        #status { text-align: center; margin-top: 12px; font-size: 13px; color: var(--ios-gray-text); font-weight: 500; min-height: 20px; }
        .map-wrapper { padding: 0 20px; margin-bottom: 20px; }
        #map { width: 100%; height: 35vh; border-radius: 24px; box-shadow: var(--shadow-sm); background-color: #E5E5EA; }
        .results-container { padding: 0 20px 60px 20px; max-width: 600px; margin: 0 auto; }
        .place-card { background: var(--ios-card); border-radius: 20px; padding: 20px; margin-bottom: 16px; box-shadow: var(--shadow-sm); transition: transform 0.2s; border: 1px solid rgba(0,0,0,0.02); }
        .place-card:active { transform: scale(0.98); background-color: #F9F9F9; }
        .place-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .place-name { font-size: 18px; font-weight: 700; color: #000; line-height: 1.3; }
        .place-rating { background: #F2F2F7; color: var(--ios-orange); padding: 4px 10px; border-radius: 50px; font-size: 13px; font-weight: 700; }
        .place-info { font-size: 14px; color: #8E8E93; margin-bottom: 12px; display: flex; align-items: center; gap: 6px; }
        .parent-tips { background-color: #F0F8FF; color: #004085; padding: 12px 16px; border-radius: 16px; font-size: 14px; line-height: 1.5; margin-top: 12px; }
        .food-tips { background-color: #FFF0F0; color: #C02520; }
        .tags { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 12px; }
        .tag { background: #F2F2F7; color: #8E8E93; font-size: 12px; font-weight: 600; padding: 6px 12px; border-radius: 100px; }
        .open-now { color: var(--ios-green); }
        .closed-now { color: var(--ios-red); }
        .empty-state { text-align: center; margin-top: 40px; color: #C7C7CC; }
        #debug-info { text-align: center; font-size: 10px; color: #ff3b30; margin-top: 20px; opacity: 0.7; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<header>
    <h1>Travel OS</h1>
    <p>Saturday, Nov 29 â€¢ Family Trip</p>
</header>

<div class="controls-container">
    <div class="btn-group">
        <button id="btn-fun" onclick="switchMode('fun')">ğŸ¡ æ‰¾å¥½ç©</button>
        <button id="btn-food" onclick="switchMode('food')">ğŸ¶ è¦ªå­ç¾é£Ÿ</button>
    </div>
    <div id="status">Ready to explore</div>
</div>

<div class="map-wrapper">
    <div id="map"></div>
</div>

<div class="results-container" id="results">
    <div class="empty-state">
        <p>é»é¸ä¸Šæ–¹æŒ‰éˆ•é–‹å§‹æ¢ç´¢</p>
    </div>
</div>

<div id="debug-info"></div>

<script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&loading=async&libraries=places,maps"></script>

<script>
    let map;
    let userLocation = null;
    let currentMarkers = []; 
    let currentMode = null; 

    // æ›´æ–°æ—¥æœŸ
    const date = new Date();
    const options = { weekday: 'short', month: 'short', day: 'numeric' };
    document.querySelector('header p').textContent = date.toLocaleDateString('en-US', options) + " â€¢ Family Trip";

    async function initMap(lat, lng) {
        const { Map } = await google.maps.importLibrary("maps");
        const center = { lat: lat, lng: lng };
        
        if (!map) {
            map = new Map(document.getElementById("map"), {
                center: center, zoom: 15, mapId: "DEMO_MAP_ID", disableDefaultUI: true, gestureHandling: "greedy"
            });
        } else {
            map.setCenter(center); map.setZoom(15);
        }

        new google.maps.Marker({
            position: center, map: map,
            icon: { path: google.maps.SymbolPath.CIRCLE, scale: 10, fillColor: "#007AFF", fillOpacity: 1, strokeWeight: 4, strokeColor: "white" },
            zIndex: 999 
        });
    }

    function clearMarkers() {
        currentMarkers.forEach(marker => marker.setMap(null));
        currentMarkers = [];
    }

    function switchMode(mode) {
        currentMode = mode;
        const btnFun = document.getElementById('btn-fun');
        const btnFood = document.getElementById('btn-food');
        document.getElementById('debug-info').innerText = ""; // æ¸…ç©ºéŒ¯èª¤è¨Šæ¯

        // 1. å¼·åˆ¶æ¸…ç©º (è§£æ±ºé¬¼æ‰“ç‰†)
        document.getElementById('results').innerHTML = '<div class="empty-state"><p>Loading...</p></div>';
        clearMarkers();

        // 2. åˆ‡æ›æ¨£å¼
        if (mode === 'fun') {
            btnFun.classList.add('active-fun');
            btnFood.className = ''; 
        } else {
            btnFood.classList.add('active-food');
            btnFun.className = '';
        }
        startExplore();
    }

    function startExplore() {
        if (!currentMode) return;
        const statusDiv = document.getElementById('status');
        statusDiv.innerHTML = "Locating...";
        
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    userLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
                    statusDiv.innerHTML = "Searching nearby...";
                    await initMap(userLocation.lat, userLocation.lng);
                    
                    if (currentMode === 'fun') {
                        await searchFunPlaces(userLocation);
                    } else {
                        await searchFoodWithFallback(userLocation);
                    }
                    statusDiv.innerHTML = "Done";
                },
                (error) => { statusDiv.innerHTML = "âŒ GPS Error"; }
            );
        } else { statusDiv.innerHTML = "âŒ No GPS Support"; }
    }

    async function searchFunPlaces(location) {
        try {
            const { Place, SearchNearbyRankPreference } = await google.maps.importLibrary("places");
            const request = {
                fields: ['displayName', 'location', 'businessStatus', 'rating', 'types', 'formattedAddress', 'userRatingCount'],
                locationRestriction: { center: location, radius: 1500 },
                includedPrimaryTypes: ['tourist_attraction', 'park', 'museum', 'shopping_mall', 'zoo', 'aquarium'],
                maxResultCount: 10,
                rankPreference: SearchNearbyRankPreference.POPULARITY,
                language: 'zh-TW',
            };
            const { places } = await Place.searchNearby(request);
            displayResults(places, 'fun');
        } catch (e) {
            document.getElementById('debug-info').innerText = "æ™¯é»æœå°‹éŒ¯èª¤: " + e.message;
        }
    }

    // ğŸ›¡ï¸ é›™é‡ä¿éšªæœå°‹ï¼šå…ˆæ‰¾è¦ªå­ -> å¤±æ•—å‰‡æ‰¾ä¸€èˆ¬
    async function searchFoodWithFallback(location) {
        const { Place } = await google.maps.importLibrary("places");
        
        // å˜—è©¦ 1: è¦ªå­ + å¯µç‰©æœå°‹
        try {
            const request = {
                textQuery: "è¦ªå­é¤å»³ OR å¯µç‰©å‹å–„é¤å»³", 
                fields: ['displayName', 'location', 'businessStatus', 'rating', 'types', 'formattedAddress', 'userRatingCount'],
                locationBias: { center: location, radius: 1000 },
                maxResultCount: 15,
                openNow: false, // æš«æ™‚é—œé–‰ openNow ä»¥é¿å…éæ¿¾å¤ªå¤šçµæœ
                language: 'zh-TW',
            };
            const { places } = await Place.searchByText(request);
            
            if (places && places.length > 0) {
                displayResults(places, 'food');
                return; // æˆåŠŸå°±çµæŸ
            }
        } catch(e) {
            console.warn("è¦ªå­æœå°‹å¤±æ•—ï¼Œåˆ‡æ›å‚™æ¡ˆ", e);
            document.getElementById('debug-info').innerText = "è‡ªå‹•åˆ‡æ›ä¸€èˆ¬æ¨¡å¼ (Error: " + e.message + ")";
        }

        // å˜—è©¦ 2 (å‚™æ¡ˆ): ä¸€èˆ¬é¤å»³æœå°‹ (ä½¿ç”¨ Nearby Searchï¼Œé€™è·Ÿæ‰¾æ™¯é»ç”¨ä¸€æ¨£çš„æŠ€è¡“ï¼Œæœ€ç©©å®š)
        try {
            document.getElementById('status').innerHTML = "åˆ‡æ›ä¸€èˆ¬æœå°‹...";
            const { SearchNearbyRankPreference } = await google.maps.importLibrary("places");
            const fallbackRequest = {
                fields: ['displayName', 'location', 'businessStatus', 'rating', 'types', 'formattedAddress', 'userRatingCount'],
                locationRestriction: { center: location, radius: 1000 },
                includedPrimaryTypes: ['restaurant', 'cafe', 'bakery'], // æ‰¾ä¸€èˆ¬é¤å»³
                maxResultCount: 15,
                rankPreference: SearchNearbyRankPreference.POPULARITY,
                language: 'zh-TW',
            };
            const { places } = await Place.searchNearby(fallbackRequest);
            displayResults(places, 'food_fallback');
        } catch(e) {
            document.getElementById('results').innerHTML = '<div class="empty-state"><p>å®Œå…¨æ‰¾ä¸åˆ°é¤å»³ğŸ˜­</p></div>';
            document.getElementById('debug-info').innerText += " | å‚™æ¡ˆä¹Ÿå¤±æ•—: " + e.message;
        }
    }

    function displayResults(places, mode) {
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = ""; 
        clearMarkers();

        if (!places || places.length === 0) {
            resultsDiv.innerHTML = '<div class="empty-state"><p>é™„è¿‘æ²’æœ‰ç¬¦åˆçš„åœ°é»</p></div>';
            return;
        }

        places.forEach((place, index) => {
            const name = place.displayName;
            const rating = place.rating;
            const address = place.formattedAddress ? place.formattedAddress.replace('å°ç£å°ä¸­å¸‚', '').replace(/^[0-9]+/, '') : "";
            const types = place.types || [];
            
            let openStatus = place.businessStatus === 'OPERATIONAL' ? "<span class='open-now'>Open</span>" : "<span class='closed-now'>Closed</span>";

            const advice = analyzeForParents(types, rating, mode);
            const isFood = mode.includes('food');
            const tipClass = isFood ? 'parent-tips food-tips' : 'parent-tips';
            const icon = isFood ? 'ğŸ¶' : 'ğŸ¡';

            const delay = index * 0.1;
            const card = document.createElement('div');
            card.className = 'place-card';
            card.style.animation = `fadeInUp 0.5s ease forwards ${delay}s`;
            card.innerHTML = `
                <div class="place-header">
                    <div class="place-name">${name}</div>
                    ${rating ? `<div class="place-rating">â˜… ${rating}</div>` : ''}
                </div>
                <div class="place-info">${openStatus} Â â€¢Â  ${address}</div>
                <div class="${tipClass}"><span class="tip-icon">${icon}</span> ${advice}</div>
                <div class="tags">${types.slice(0, 3).map(type => `<span class="tag">${formatType(type)}</span>`).join('')}</div>
            `;
            
            card.onclick = () => {
                window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(name)}&query_place_id=${place.id}`, '_blank');
            };
            resultsDiv.appendChild(card);
            
            const marker = new google.maps.Marker({
                position: place.location, map: map, title: name,
            });
            currentMarkers.push(marker);
        });
    }

    function analyzeForParents(types, rating, mode) {
        let advice = "";
        if (mode.includes('food')) {
            if (mode === 'food') advice = "ç¬¦åˆè¦ªå­/å¯µç‰©å‹å–„æœå°‹çµæœã€‚";
            else advice = "é™„è¿‘ç†±é–€é¤å»³ (ä¸€èˆ¬æ¨¡å¼)ã€‚";
            
            if (rating > 4.5) advice += " äººæ°£é«˜å»ºè­°è¨‚ä½ã€‚";
            if (types.includes('cafe')) advice = "é©åˆä¼‘æ¯å–å’–å•¡ã€‚";
        } else {
            if (types.includes('park')) advice = "3æ­²å¯¶æœ€æ„›ï¼ç›¡æƒ…æ”¾é›»ã€‚";
            else if (types.includes('museum') || types.includes('aquarium')) advice = "å®¤å…§å®‰å…¨ï¼Œå¥½å¥‡å¯¶å¯¶æ™‚é–“ã€‚";
            else if (types.includes('shopping_mall')) advice = "åœè»Šè£œçµ¦æ–¹ä¾¿ï¼Œæœ‰å†·æ°£ã€‚";
            else advice = "ç†±é–€æ™¯é»ï¼Œè«‹ç•™æ„äººæ½®ã€‚";
        }
        return advice;
    }

    function formatType(type) {
        const dict = { 'tourist_attraction': 'æ™¯é»', 'park': 'å…¬åœ’', 'restaurant': 'é¤å»³', 'cafe': 'å’–å•¡', 'store': 'å•†åº—', 'food': 'ç¾é£Ÿ', 'bakery': 'çƒ˜ç„™' };
        return dict[type] || 'åœ°é»';
    }
</script>
</body>
</html>
